var image,client,uploader={file:"",totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0},Buffer=OSS.Buffer,STS=OSS.STS,FileMaxSize=13e6,TotalFilesMaxSize=1,ossUpload="",uploadRetryCount=0;const uploadRetryCountMax=5;var obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/";function uploadPreview(e){if(e.files&&e.files[0]){var o=new FileReader;o.onload=function(e){$("#cover").attr("src",e.target.result),$("#cover").removeClass("d-none")},o.readAsDataURL(e.files[0])}}OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var e=this;$('input[type="file"]').change((function(o){var a=o.target.files[0];if(a)if(a.size<=5e3&&$.wnoty({type:"error",autohide:!1,message:"The image you've chosen is too small. Please choose a file greater than 5KB but lower than 13MB!"}),a.size<=FileMaxSize){uploader.file=a,uploader.totalFilesSize=a.size,uploader.totalFilesNum=1;var r=genKey(a.type);$.wnoty({type:"info",message:"Uploading Cover Image please wait."}),e.uploadFile(a,r)}else $.wnoty({type:"error",autohide:!1,message:"This image/file is larger than 13MB, please select images small than 13MB "});else $.wnoty({type:"error",autohide:!1,message:"No image selected , Please select one or more images"})}))},uploadFile:function(e,o){applyTokenDo().then(a=>{client=a.direct?new OSS({region:a.region,accessKeyId:a.accessId,accessKeySecret:a.stsTokenKey,bucket:a.bucket}):new OSS({region:a.region,accessKeyId:a.accessKeyId,accessKeySecret:a.accessKeySecret,stsToken:a.SecurityToken,bucket:a.bucket});const r=async()=>{try{return await client.multipartUpload(o,e,{progress:progress,partSize:204800,timeout:12e4}).then((function(o){uploader.uploadFinishedFilesNum++,uploader.curFileSize+=e.size,progressBarNum=100*1..toFixed(2),progressBar=100*1..toFixed(2)+"%",100==progressBarNum&&($.wnoty({type:"success",message:"Cover Image uploaded Successfully."}),$.ajax({url:obrisk_oss_url+o.name+"?x-oss-process=image/average-hue",success:function(){$('[name="image"]').val(o.name)},error:function(e){uploadRetryCount<5?(uploadRetryCount++,console.error("uploadRetryCount : "+uploadRetryCount),r()):$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image, please try again later!"})}}))})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),-1!==e.name.toLowerCase().indexOf("connectiontimeout")&&uploadRetryCount<5?(uploadRetryCount++,console.error("uploadRetryCount : "+uploadRetryCount),r()):$totalProgressbar.css("width","100%").html("Upload failed!")})}catch(e){$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured during the image upload,                     Please try again later or contact us via support@obrisk.com"+e}),$(".start-uploader").css("display","block"),console.log(e)}};return r()}).catch(e=>{$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured before upload started, Please try again later or contact us via support@obrisk.com"+e}),console.log(e)})}};var progressBar=0,progress="",$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$totalProgressbar=$("#totalProgressBar"),applyTokenDo=(progress=function(e){return function(e){$totalProgressbar.css("width","100%").html("Upload started, please wait..."),e()}},function(){var e=oss_url;return new Promise((o,a)=>{$.ajax({url:e,success:function(e){o(e)},error:function(e){a(e)}})})});function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(e){var o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)}))+"."+e.split("/")[1]+"/",a=(new Date).toISOString().split("T")[0];return"media/images/"+app+"/"+user+"/"+a+"/"+o}function slugify(e){const o="àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœøṕŕßśșțùúüûǘẃẍÿź·/_,:;",a=new RegExp(o.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,"-").replace(a,e=>"aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------".charAt(o.indexOf(e))).replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}$((function(){(ossUpload=new OssUpload).init()}));