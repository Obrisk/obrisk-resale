function printError(e){document.getElementsByClassName("notification")[0].classList.remove("is-hidden"),document.getElementById("notf-msg").innerHTML=e,window.scroll({top:0,left:0,behavior:"smooth"})}function choosePic(){document.getElementById("temp_pic").click(),document.getElementById("startUpload").classList.remove("is-hidden"),document.getElementById("choosePic").classList.add("is-hidden")}var image,client,uploader={file:"",totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0},Buffer=OSS.Buffer,STS=OSS.STS,FileMaxSize=2e8,TotalFilesMaxSize=1,ossUpload="",uploadRetryCount=0;const uploadRetryCountMax=5;var obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/";function uploadPreview(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#avatar").attr("src",e.target.result)},t.readAsDataURL(e.files[0]),$("#startUpload").show()}}OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var e=this;$('input[type="file"]').change((function(e){var t=e.target.files[0];$("#uploader .placeholder").hide(),$("#statusBar").css("display","flex"),t?(t.size<=5e3&&printError("The image is too small. Pls choose image greater than 5KB"),t.size<=FileMaxSize?(uploader.file=t,uploader.totalFilesSize=t.size):printError("This image is larger than 20MB, pls select smaller image ")):printError("No image selected , Pls select an image first"),uploader.totalFilesNum=1})),$("#startUpload").click((function(t){if(0==uploader.totalFilesNum)t.preventDefault(),printError("Please select the image to be saved by clicking the choose pic button!");else{var o=genKey(),r=uploader.file;$("#startUpload").hide(),e.uploadFile(r,o)}}))},uploadFile:function(e,t){applyTokenDo().then(o=>{if(void 0!==(client=o.direct?new OSS({region:o.region,accessKeyId:o.accessId,accessKeySecret:o.stsTokenKey,bucket:o.bucket}):new OSS({region:o.region,accessKeyId:o.accessKeyId,accessKeySecret:o.accessKeySecret,stsToken:o.SecurityToken,bucket:o.bucket}))){const o=async()=>{try{return await client.multipartUpload(t,e,{partSize:204800,timeout:12e4}).then((function(t){uploader.uploadFinishedFilesNum++,uploader.curFileSize+=e.size,100==100*1..toFixed(2)&&$.ajax({url:obrisk_oss_url+t.name+"?x-oss-process=image/average-hue",success:function(){$.ajax({url:"/users/update-profile-pic/",data:{profile_pic:t.name},cache:!1,type:"POST",success:function(e){e.success?($("#startUpload").hide(),document.getElementById("choosePic").classList.remove("is-hidden"),document.getElementById("successText").innerHTML="The photo has been updated✔️"):$("#startUpload").show()},error:function(e){console.log(e),$("#startUpload").show()}})},error:function(e){uploadRetryCount<5?(uploadRetryCount++,console.error("uploadRetryCount : "+uploadRetryCount),o()):($.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image, please try again later!"}),$("#startUpload").show())}})})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),-1!==e.name.toLowerCase().indexOf("connectiontimeout")&&uploadRetryCount<5&&(uploadRetryCount++,console.error("uploadRetryCount : "+uploadRetryCount),o())})}catch(e){printError("Oops! an error has occured. Pls try again or add our wechat Obrisk"),$(".start-uploader").css("display","block"),console.log(e)}};return o()}printError("Oops! an error has occured. Pls try again or add our wechat Obrisk"),$(".start-uploader").css("display","block")}).catch(e=>{printError("Oops! an error has occured. Pls try again or add our wechat Obrisk"),console.log(e)})}};var applyTokenDo=function(){var e=oss_url;return new Promise((t,o)=>{$.ajax({url:e,success:function(e){t(e)},error:function(e){o(e)}})})};function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(){return"media/images/profile_pics/"+user+"/pics/"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function slugify(e){const t="àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœøṕŕßśșțùúüûǘẃẍÿź·/_,:;",o=new RegExp(t.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,"-").replace(o,e=>"aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------".charAt(t.indexOf(e))).replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".close-dj-messages").forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.parentElement.classList.add("is-hidden"),e.stopPropagation()})}),$.ajaxSetup({beforeSend:function(e,t){var o;o=t.type,/^(GET|HEAD|OPTIONS|TRACE)$/.test(o)||this.crossDomain||e.setRequestHeader("X-CSRFToken",csrftoken)}}),(ossUpload=new OssUpload).init(),$("#update-profile").click((function(e){$("select[name='province']").val()&&!$("select[name='city']").val()?(e.preventDefault(),printError("Province and city must be updated together")):($("input[name='city']").val($("select[name='city']").val()),$("input[name='province_region']").val($("select[name='province']").val()),$("#update").submit())}))}));