var image,client,uploader={file:"",totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0},Buffer=OSS.Buffer,STS=OSS.STS,FileMaxSize=13e6,TotalFilesMaxSize=1,ossUpload="",uploadRetryCount=0;const uploadRetryCountMax=5;var obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/";function uploadPreview(e){if(e.files&&e.files[0]){var o=new FileReader;o.onload=function(e){$("#avatar").attr("src",e.target.result)},o.readAsDataURL(e.files[0]),$totalProgressbar.css("width","100%"),$("#startUpload").show()}}OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var e=this;$('input[type="file"]').change((function(e){var o=e.target.files[0];$("#uploader .placeholder").hide(),$("#statusBar").css("display","flex"),o?(o.size<=5e3&&$.wnoty({type:"error",autohide:!1,message:"The image you've chosen is too small. Please choose a file greater than 5KB but lower than 13MB!"}),o.size<=FileMaxSize?(uploader.file=o,uploader.totalFilesSize=o.size):$.wnoty({type:"error",autohide:!1,message:"This image/file is larger than 13MB, please select images small than 13MB "})):$.wnoty({type:"error",autohide:!1,message:"No image selected , Please select one or more images"}),uploader.totalFilesNum=1})),$("#startUpload").click((function(o){if(0==uploader.totalFilesNum)o.preventDefault(),$.wnoty({type:"error",autohide:!1,message:"Please select the image to be saved by clicking the choose pic button!"});else{var t=genKey(),a=uploader.file;$totalProgressbar.css("width","100%").html("Upload started..."),$("#startUpload").hide(),e.uploadFile(a,t)}}))},uploadFile:function(e,o){applyTokenDo().then(t=>{if(void 0!==(client=t.direct?new OSS({region:t.region,accessKeyId:t.accessId,accessKeySecret:t.stsTokenKey,bucket:t.bucket}):new OSS({region:t.region,accessKeyId:t.accessKeyId,accessKeySecret:t.accessKeySecret,stsToken:t.SecurityToken,bucket:t.bucket}))){const t=async()=>{try{return await client.multipartUpload(o,e,{progress:progress,partSize:204800,timeout:12e4}).then((function(o){uploader.uploadFinishedFilesNum++,uploader.curFileSize+=e.size,progressBarNum=100*1..toFixed(2),progressBar=100*1..toFixed(2)+"%",100==progressBarNum&&($totalProgressbar.css("width","100%").html("Processing...."),$.ajax({url:obrisk_oss_url+o.name+"?x-oss-process=image/average-hue",success:function(){$.ajax({url:"/users/update-profile-pic/",data:{profile_pic:o.name},cache:!1,type:"POST",success:function(e){e.success?($totalProgressbar.css("width","100%").html("New pic is saved successfully!"),$("#startUpload").hide()):($totalProgressbar.css("width","100%").html("<p>"+e.error_message+"</p>"),$("#startUpload").show())},error:function(e){$totalProgressbar.css("width","100%").html("<p> Upload failed </p>"),console.log(e),$("#startUpload").show()}})},error:function(e){uploadRetryCount<5?(uploadRetryCount++,console.error("uploadRetryCount : "+uploadRetryCount),t()):($.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image, please try again later!"}),$("#startUpload").show())}}))})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),-1!==e.name.toLowerCase().indexOf("connectiontimeout")&&uploadRetryCount<5?(uploadRetryCount++,console.error("uploadRetryCount : "+uploadRetryCount),t()):$totalProgressbar.css("width","100%").html("Upload failed!")})}catch(e){$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured during the image upload,                     Please try again later or contact us via support@obrisk.com"+e}),$(".start-uploader").css("display","block"),console.log(e)}};return t()}$.wnoty({type:"error",autohide:!1,message:"Oops!, it looks like there is a network problem,             Please try again later or contact us at support@obrisk.com"}),$(".start-uploader").css("display","block")}).catch(e=>{$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured before upload started, Please try again later or contact us via support@obrisk.com"+e}),console.log(e)})}};var progressBar=0,progress="",$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$totalProgressbar=$("#totalProgressBar"),applyTokenDo=(progress=function(e){return function(e){$totalProgressbar.css("width","100%").html("Upload started, please wait..."),e()}},function(){var e=oss_url;return new Promise((o,t)=>{$.ajax({url:e,success:function(e){o(e)},error:function(e){t(e)}})})});function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(){return"media/images/profile_pics/"+user+"/pics/"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)}))}function slugify(e){const o="àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœøṕŕßśșțùúüûǘẃẍÿź·/_,:;",t=new RegExp(o.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,"-").replace(t,e=>"aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------".charAt(o.indexOf(e))).replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}$((function(){$.ajaxSetup({beforeSend:function(e,o){var t;t=o.type,/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)||this.crossDomain||e.setRequestHeader("X-CSRFToken",csrftoken)}}),(ossUpload=new OssUpload).init(),$("#update-profile").click((function(e){$("select[name='city']").val()&&$("select[name='province']")?($("input[name='city']").val($("select[name='city']").val()),$("input[name='province_region']").val($("select[name='province']").val()),$("#update").submit()):(e.preventDefault(),$.wnoty({type:"error",autohide:!1,message:"Please enter your address!"}))}))}));