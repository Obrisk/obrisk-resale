var uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}};const Buffer=OSS.Buffer,STS=OSS.STS,obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/",MaxImageSize=3e7,MaxVideoSize=2e8,s3Upload=!1,aliyunUpload=!0;var img_error,client,imgClient,images="",videos="",ossUpload="",files="",curIndex=0,NumberOfSelectedFiles=0,hasErrors=!1,retryCount=0,retryCountMax=5,TotalFilesMaxSize=10;OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var e=this;$("#chooseFile, #addBtn").click((function(){document.getElementById("image-file").click()})),$("#addVideo").click((function(){document.getElementById("video-file").click()})),$("#image-file").change((function(s){$("#wrapper .container").css("display","block"),$(".submit-button").removeClass("is-disabled"),files=s.target.files,curIndex=uploader.fileList.length,NumberOfSelectedFiles=files.length;var t=null;$("#uploader .placeholder").hide();var a=TotalFilesMaxSize-curIndex;if(0===a)$.wnoty({type:"error",autohide:!1,message:"Only "+TotalFilesMaxSize+" images are allowed"}),$("#addBtn").hide();else if(0===files.length)$.wnoty({type:"error",autohide:!1,message:"No image selected , Please select one or more images"});else if(NumberOfSelectedFiles<=a&&NumberOfSelectedFiles>0)for(var i=0;i<NumberOfSelectedFiles;i++)(t=files[i]).size<=3e7?(uploader.fileList[curIndex+i]=t,t.id=uploader.fileList[curIndex+i].id="image"+(curIndex+i+1),uploader.fileStats.totalFilesSize+=t.size,e.addFile(t),$("#addVideo").hide()):$.wnoty({type:"error",autohide:!1,message:t.name+" is larger than 13MB, please select images small than 13MB "});else{for(i=0;i<NumberOfSelectedFiles&&uploader.fileList.length<TotalFilesMaxSize;i++)(t=files[i]).size<=3e7?(uploader.fileList[curIndex+i]=t,t.id=uploader.fileList[curIndex+i].id="image"+(curIndex+i+1),uploader.fileStats.totalFilesSize+=t.size,e.addFile(t),$("#addVideo").hide()):$.wnoty({type:"error",autohide:!1,message:t.name+" is larger than 13MB, please select images small than 13MB "});$.wnoty({type:"error",autohide:!1,message:"Only "+TotalFilesMaxSize+" images are allowed"})}uploader.fileStats.totalFilesNum=uploader.fileList.length})),$("#video-file").change((function(s){$("#wrapper .container").css("display","block"),$(".submit-button").removeClass("is-disabled"),files=s.target.files,curIndex=uploader.fileList.length,NumberOfSelectedFiles=files.length;var t=null;$("#uploader .placeholder").hide();var a=1-curIndex;if(0==a)$.wnoty({type:"error",autohide:!1,message:"Only 1 video is allowed"}),$("#addVideo").hide();else if(0==files.length)$.wnoty({type:"error",autohide:!1,message:"No video selected, Please select one or more videos"});else if(NumberOfSelectedFiles<=a&&NumberOfSelectedFiles>0)for(var i=0;i<NumberOfSelectedFiles;i++)(t=files[i]).size<=2e8?(uploader.fileList[curIndex+i]=t,t.id=uploader.fileList[curIndex+i].id="video"+(curIndex+i+1),uploader.fileStats.totalFilesSize+=t.size,e.addFile(t),$("#addBtn").hide()):$.wnoty({type:"error",autohide:!1,message:t.name+" is larger than 13MB, please select videos small than 13MB "});else{for(i=0;i<NumberOfSelectedFiles&&uploader.fileList.length<1;i++)(t=files[i]).size<=2e8?(uploader.fileList[curIndex+i]=t,t.id=uploader.fileList[curIndex+i].id="video"+(curIndex+i+1),uploader.fileStats.totalFilesSize+=t.size,e.addFile(t),$("#addBtn").hide()):$.wnoty({type:"error",autohide:!1,message:t.name+" is larger than 13MB, please select videos small than 13MB "});$.wnoty({type:"error",autohide:!1,message:"Only 1 video is allowed"})}uploader.fileStats.totalFilesNum=uploader.fileList.length})),$("body").on("submitClicked",(function(){$("#statusBar").css("display","flex");var s,t=uploader.fileStats.totalFilesNum;$(".start-uploader").css("display","none"),$totalProgressbar.css("width","40%").html("Upload Started please wait...");for(var a=0;a<t;a++){var i=genKey((s=uploader.fileList[a]).type);e.uploadFile(s,i,s.type)}})),$(".queueList .filelist").delegate("li span.cancel","click",(function(){for(var e=$(this).parent().parent(),s=e.attr("id"),t=uploader.fileList.length,a=0;a<t;a++)if(t<=0&&($("#addBtn").show(),$("#addVideo").hide()),uploader.fileList[a].id==s){uploader.fileStats.totalFilesSize-=uploader.fileList[a].size,uploader.fileList.splice(a,1),uploader.fileStats.totalFilesNum=uploader.fileList.length;break}e.remove(),0==uploader.fileList.length&&($("#wrapper .placeholder").css("display","block"),$("#addBtn").show(),$("#addVideo").show())}))},uploadFile:function(e,s,t){$totalProgressbar.css("width","30%").html("Uploading..."),applyTokenDo().then(a=>{if(void 0!==(client=a.direct?new OSS({region:a.region,accessKeyId:a.accessId,accessKeySecret:a.stsTokenKey,bucket:a.bucket}):new OSS({region:a.region,accessKeyId:a.accessKeyId,accessKeySecret:a.accessKeySecret,stsToken:a.SecurityToken,bucket:a.bucket}))){const a=async()=>{try{return await client.multipartUpload(s,e,{progress:progress,partSize:204800,timeout:12e4}).then((function(s){/^video/.test(t)&&(url=obrisk_oss_url+s.name),$("#"+e.id).children(".success-span").addClass("success"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",/^image/.test(t)?images+=""==images?s.name:","+s.name:videos+=""==videos?s.name:","+s.name,100==progressBarNum?($totalProgressbar.css("width",progressBar).html("Upload complete"),$("body").trigger("uploadComplete")):(progressBar=parseFloat(progressBar),$totalProgressbar.css("width",progressBar.toFixed(0)).html(progressBar))})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),console.log("err.request : "+e.requestId),$totalProgressbar.css("width","40%").html("Retrying..."),-1!==e.name.toLowerCase().indexOf("connectiontimeout")?retryCount<retryCountMax?(retryCount++,console.error("retryCount : "+retryCount),a()):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),$("ul.filelist li").children(".success-span").addClass("fail"),$("#addBtn").hide(),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,$("#retry-button").removeClass("is-hidden"),images||("classifieds"==app&&(images="classifieds/error-img.jpg"),$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured on image(s).                                 But you can submit the post without images ."}))):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,$("#retry-button").removeClass("is-hidden"),images||("classifieds"==app&&(images="classifieds/error-img.jpg"),console.log(hasErrors),hasErrors||($.wnoty({type:"error",autohide:!1,message:"Oops! an error occured on image(s).                                             But you can submit the post without images ."}),hasErrors=!0)))})}catch(e){$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s),                     Please try again or contact us via WechatID: Obrisk. "}),$(".start-uploader").css("display","block"),console.log(e)}};return a()}$.wnoty({type:"error",autohide:!1,message:"Oops!, it looks like there is a network problem,                 try again later or contact us via wechatID: Obrisk"}),$(".start-uploader").css("display","block")}).catch(e=>{$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured. Try again later or contact us via wechatID: Obrisk"}),console.log(e)})},addFile:function(e){var s,t=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="upload-state"><span></span></p><span class="success-span"></span></li>'),a=($('<div class="file-panel"><span class="cancel">cancel</span></div>').appendTo(t),t.find("p.upload-state span"),t.find("p.imgWrap"));$('<p class="error"></p>');if(/^image\//.test(e.type)){var i=document.createElement("img");i.classList.add("obj"),i.file=e,i.style.width="100%",i.style.height="100%",a.empty().append($(i));var r=new FileReader;r.onload=(s=i,function(e){s.src=e.target.result}),r.readAsDataURL(e)}else{var l=new FileReader;l.onload=function(){var s=new Blob([l.result],{type:e.type}),t=URL.createObjectURL(s),i=document.createElement("video"),r=function(){o()&&(i.removeEventListener("timeupdate",r),i.pause())};i.addEventListener("loadeddata",(function(){o()&&i.removeEventListener("timeupdate",r)}));var o=function(){var e=document.createElement("canvas");e.width=i.videoWidth,e.height=i.videoHeight,e.getContext("2d").drawImage(i,0,0,e.width,e.height);var s=e.toDataURL(),r=s.length>1e5;if(r){var l=document.createElement("img");l.src=s,a.empty().append($(l)),URL.revokeObjectURL(t)}return r};i.addEventListener("timeupdate",r),i.preload="metadata",i.src=t,i.muted=!0,i.playsInline=!0,i.play()},l.readAsArrayBuffer(e)}t.appendTo($queue)}};var progressBar=0,progress="",$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$totalProgressbar=$("#totalProgressBar"),applyTokenDo=(progress=function(e){return function(e){$totalProgressbar.css("width",progressBar),e()}},function(){var e=oss_url;return new Promise((s,t)=>{$.ajax({url:e,success:function(e){s(e)},error:function(e){t(e)}})})}),getPresignedURL=function(){return new Promise((e,s)=>{$.ajax({url:"/get-oss-auth/stories.video/",success:function(s){e(s)},error:function(e){s(e)}})})};function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(e){var s="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var s=16*Math.random()|0;return("x"==e?s:3&s|8).toString(16)}))+"."+e.split("/")[1],t=(new Date).toISOString().split("T")[0];if("stories"==app)return/^video/.test(e)?"media/videos/"+app+"/"+slugify(user)+"/"+t+"/"+s:"media/images/"+app+"/"+slugify(user)+"/"+t+"/"+s;if("classifieds"==app){const e=document.getElementById("id_title").value;return"undefined"===e?"media/images/"+app+"/"+slugify(user)+"/item-no-title/"+t+"/"+s:"media/images/"+app+"/"+slugify(user)+"/"+slugify(e)+"/"+t+"/"+s}return"articles"==app?"media/images/"+app+"/"+slugify(user)+"/"+t+"/"+s:void 0}$((function(){(ossUpload=new OssUpload).init(),$("body").on("resetUpload",(function(){uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}},$(".queueList ul").html(""),img_error="",images="",$totalProgressbar.css("width","0%").html(""),hasErrors=!1,$("#addVideo").show(),$("#addBtn").show()})),$("#retry-button").click((function(e){e.preventDefault(),$("body").trigger("resetUpload"),$("#retry-button").addClass("is-hidden"),$("#addBtn").show()}))}));