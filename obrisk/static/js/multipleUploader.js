var img_error,client,imgClient,uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}},Buffer=OSS.Buffer,STS=OSS.STS,MaxImageSize=13e6,MaxVideoSize=2e8,images="",videos="",ossUpload="",obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/",hasErrors=!1,retryCount=0,retryCountMax=5,TotalFilesMaxSize=8;const s3Upload=!1,aliyunUpload=!0;OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var e=this;$("#chooseFile, #addBtn").click((function(){document.getElementById("image-file").click()})),$("#addVideo").click((function(){document.getElementById("video-file").click()})),$("#image-file").change((function(s){$("#wrapper .container").css("display","block"),$(".submit-button").removeClass("is-disabled");var a=s.target.files,t=uploader.fileList.length,r=a.length,i=null;$("#uploader .placeholder").hide();var o=TotalFilesMaxSize-t;if(0==o)$.wnoty({type:"error",autohide:!1,message:"Only "+TotalFilesMaxSize+" images are allowed"}),$("#addBtn").hide();else if(0==a.length)$.wnoty({type:"error",autohide:!1,message:"No image selected , Please select one or more images"});else if(r<=o&&r>0)for(var l=0;l<r;l++)(i=a[l]).size<=MaxImageSize?(uploader.fileList[t+l]=i,i.id=uploader.fileList[t+l].id="image"+(t+l+1),uploader.fileStats.totalFilesSize+=i.size,e.addFile(i),$("#addVideo").hide()):$.wnoty({type:"error",autohide:!1,message:i.name+" is larger than 13MB, please select images small than 13MB "});else{for(l=0;l<r&&uploader.fileList.length<TotalFilesMaxSize;l++)(i=a[l]).size<=MaxImageSize?(uploader.fileList[t+l]=i,i.id=uploader.fileList[t+l].id="image"+(t+l+1),uploader.fileStats.totalFilesSize+=i.size,e.addFile(i),$("#addVideo").hide()):$.wnoty({type:"error",autohide:!1,message:i.name+" is larger than 13MB, please select images small than 13MB "});$.wnoty({type:"error",autohide:!1,message:"Only "+TotalFilesMaxSize+" images are allowed"})}uploader.fileStats.totalFilesNum=uploader.fileList.length})),$("#video-file").change((function(s){$("#wrapper .container").css("display","block"),$(".submit-button").removeClass("is-disabled");var a=s.target.files,t=uploader.fileList.length,r=a.length,i=null;$("#uploader .placeholder").hide();var o=1-t;if(0==o)$.wnoty({type:"error",autohide:!1,message:"Only 1 video is allowed"}),$("#addVideo").hide();else if(0==a.length)$.wnoty({type:"error",autohide:!1,message:"No video selected , Please select one or more videos"});else if(r<=o&&r>0)for(var l=0;l<r;l++)(i=a[l]).size<=MaxVideoSize?(uploader.fileList[t+l]=i,i.id=uploader.fileList[t+l].id="video"+(t+l+1),uploader.fileStats.totalFilesSize+=i.size,e.addFile(i),$("#addBtn").hide()):$.wnoty({type:"error",autohide:!1,message:i.name+" is larger than 13MB, please select videos small than 13MB "});else{for(l=0;l<r&&uploader.fileList.length<1;l++)(i=a[l]).size<=MaxVideoSize?(uploader.fileList[t+l]=i,i.id=uploader.fileList[t+l].id="video"+(t+l+1),uploader.fileStats.totalFilesSize+=i.size,e.addFile(i),$("#addBtn").hide()):$.wnoty({type:"error",autohide:!1,message:i.name+" is larger than 13MB, please select videos small than 13MB "});$.wnoty({type:"error",autohide:!1,message:"Only 1 video is allowed"})}uploader.fileStats.totalFilesNum=uploader.fileList.length})),$("body").on("submitClicked",(function(){$("#statusBar").css("display","flex");var s,a=uploader.fileStats.totalFilesNum;$(".start-uploader").css("display","none"),$totalProgressbar.css("width","40%").html("Upload Started please wait...");for(var t=0;t<a;t++){var r=genKey((s=uploader.fileList[t]).type);e.uploadFile(s,r,s.type)}})),$(".queueList .filelist").delegate("li span.cancel","click",(function(){for(var e=$(this).parent().parent(),s=e.attr("id"),a=uploader.fileList.length,t=0;t<a;t++)if(a<=0&&($("#addBtn").show(),$("#addVideo").hide()),uploader.fileList[t].id==s){uploader.fileStats.totalFilesSize-=uploader.fileList[t].size,uploader.fileList.splice(t,1),uploader.fileStats.totalFilesNum=uploader.fileList.length;break}e.remove(),0==uploader.fileList.length&&($("#wrapper .placeholder").css("display","block"),$("#addBtn").show(),$("#addVideo").show())}))},uploadFile:function(e,s,a){$totalProgressbar.css("width","30%").html("Uploading..."),applyTokenDo().then(t=>{if(void 0!==(client=t.direct?new OSS({region:t.region,accessKeyId:t.accessId,accessKeySecret:t.stsTokenKey,bucket:t.bucket}):new OSS({region:t.region,accessKeyId:t.accessKeyId,accessKeySecret:t.accessKeySecret,stsToken:t.SecurityToken,bucket:t.bucket}))){const t=async()=>{try{return await client.multipartUpload(s,e,{progress:progress,partSize:204800,timeout:12e4}).then((function(s){/^video/.test(a)?url=obrisk_oss_url+s.name:url=obrisk_oss_url+s.name+"?x-oss-process=image/average-hue",$.ajax({url:url,success:function(){$("#"+e.id).children(".success-span").addClass("success"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",/^image/.test(a)?images+=""==images?s.name:","+s.name:videos+=""==videos?s.name:","+s.name,100==progressBarNum?($totalProgressbar.css("width",progressBar).html("Upload complete"),$("body").trigger("uploadComplete")):(progressBar=parseFloat(progressBar),$totalProgressbar.css("width",progressBar.toFixed(0)).html(progressBar))},error:function(a){retryCount<retryCountMax?(retryCount++,console.error("retryCount : "+retryCount),t()):($("#"+e.id).children(".success-span").addClass("fail"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",100==progressBarNum?$totalProgressbar.css("width",progressBar).html("Upload complete"):$totalProgressbar.css("width",progressBar).html(progressBar),img_error=s.name+", Message: Corrupted image, RequestID: "+s.name,$("#retry-button").removeClass("is-hidden"),images||("classifieds"==app?(images="classifieds/error-img.jpg",$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s).                                                     But you can submit this post without images ."})):$.wnoty({type:"error",autohide:!1,message:"Sorry! an error occured when uploading your image(s). You can post without images"})))}})})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),console.log("err.request : "+e.requestId),$totalProgressbar.css("width","40%").html("Retrying..."),-1!==e.name.toLowerCase().indexOf("connectiontimeout")?retryCount<retryCountMax?(retryCount++,console.error("retryCount : "+retryCount),t()):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),$("ul.filelist li").children(".success-span").addClass("fail"),$("#addBtn").hide(),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,$("#retry-button").removeClass("is-hidden"),images||("classifieds"==app&&(images="classifieds/error-img.jpg"),$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s).                                             But you can submit this post without images ."}))):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,$("#retry-button").removeClass("is-hidden"),images||("classifieds"==app&&(images="classifieds/error-img.jpg"),console.log(hasErrors),hasErrors||($.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s).                                             But you can submit this post without images ."}),hasErrors=!0)))})}catch(e){$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s),                     Please try again later or contact us via support@obrisk.com. "}),$(".start-uploader").css("display","block"),console.log(e)}};return t()}$.wnoty({type:"error",autohide:!1,message:"Oops!, it looks like there is a network problem,             Please try again later or contact us at support@obrisk.com"}),$(".start-uploader").css("display","block")}).catch(e=>{$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured before upload started, Please try again later or contact us via support@obrisk.com"}),console.log(e)})},addFile:function(e){var s,a=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="upload-state"><span></span></p><span class="success-span"></span></li>'),t=($('<div class="file-panel"><span class="cancel">cancel</span></div>').appendTo(a),a.find("p.upload-state span"),a.find("p.imgWrap"));$('<p class="error"></p>');if(/^image\//.test(e.type)){var r=document.createElement("img");r.classList.add("obj"),r.file=e,r.style.width="100%",r.style.height="100%",t.empty().append($(r));var i=new FileReader;i.onload=(s=r,function(e){s.src=e.target.result}),i.readAsDataURL(e)}else{var o=new FileReader;o.onload=function(){var s=new Blob([o.result],{type:e.type}),a=URL.createObjectURL(s),r=document.createElement("video"),i=function(){l()&&(r.removeEventListener("timeupdate",i),r.pause())};r.addEventListener("loadeddata",(function(){l()&&r.removeEventListener("timeupdate",i)}));var l=function(){var e=document.createElement("canvas");e.width=r.videoWidth,e.height=r.videoHeight,e.getContext("2d").drawImage(r,0,0,e.width,e.height);var s=e.toDataURL(),i=s.length>1e5;if(i){var o=document.createElement("img");o.src=s,t.empty().append($(o)),URL.revokeObjectURL(a)}return i};r.addEventListener("timeupdate",i),r.preload="metadata",r.src=a,r.muted=!0,r.playsInline=!0,r.play()},o.readAsArrayBuffer(e)}a.appendTo($queue)}};var progressBar=0,progress="",$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$totalProgressbar=$("#totalProgressBar"),applyTokenDo=(progress=function(e){return function(e){$totalProgressbar.css("width",progressBar),e()}},function(){var e=oss_url;return new Promise((s,a)=>{$.ajax({url:e,success:function(e){s(e)},error:function(e){a(e)}})})}),getPresignedURL=function(){return new Promise((e,s)=>{$.ajax({url:"/get-oss-auth/stories.video/",success:function(s){e(s)},error:function(e){s(e)}})})};function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(e){var s="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var s=16*Math.random()|0;return("x"==e?s:3&s|8).toString(16)}))+"."+e.split("/")[1]+"/",a=(new Date).toISOString().split("T")[0];return"stories"==app?/^video/.test(e)?"media/videos/"+app+"/"+user+"/"+a+"/"+s:"media/images/"+app+"/"+user+"/"+a+"/"+s:"classifieds"==app||"articles"==app?"media/images/"+app+"/"+user+"/"+a+"/"+s:void 0}function slugify(e){const s="àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœøṕŕßśșțùúüûǘẃẍÿź·/_,:;",a=new RegExp(s.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,"-").replace(a,e=>"aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------".charAt(s.indexOf(e))).replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}$((function(){(ossUpload=new OssUpload).init(),$("body").on("resetUpload",(function(){uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}},$(".queueList ul").html(""),img_error="",images="",$totalProgressbar.css("width","0%").html(""),hasErrors=!1,$("#addVideo").show(),$("#addBtn").show()})),$("#retry-button").click((function(e){e.preventDefault(),$("body").trigger("resetUpload"),$("#retry-button").addClass("is-hidden"),$("#addBtn").show()}))}));