function scrollMessages(){$("textarea[name='message']").focus(),$("#conversation").scrollTop(99999999999)}$((function(){var e=document.querySelector(".message-scroll"),s=document.querySelector("textarea");s.addEventListener("keydown",(function(){setTimeout((function(){var a=Math.min(100,s.scrollHeight);e.style.cssText="height:"+a+"px",s.style.cssText="height:"+a+"px"}),0)}));var a=function(e){for(var s=e+"=",a=document.cookie.split(";"),t=0;t<a.length;t++){for(var i=a[t];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(s))return i.substring(s.length,i.length)}return null};function t(e){var s=e;$.ajax({type:"get",url:s,success:function(e){var s=null==e.active_thumbnail?"/static/img/user.png":e.active_thumbnail;$(".avatar-container").append(`<img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${s}" alt="Picture Profile"\n                        style="width:30px;height:30px;border-radius: 50%;"\n                        class=" user-avatar rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n                    `),$(".username").append(`  <span>${e.active_username}</span>`),e.msgs.map((function(a){a.sender_username==e.active_username?(null!=a.image&&$("#conversation").append(`<div class="chat-message is-received">\n\n                          <img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${s}" alt="Picture Profile"\n                              style="width:30px;height:30px;border-radius: 50%;"\n                              class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n                          <div class="message-block">\n                              <span>${moment(a.timestamp).format("MMM. Do h:mm")}</span>\n                              <a data-fancybox="gallery" style="width: 250px; height: 250px;"\n                href="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${a.image}"><img\n                    style="width: 250px; height: 250px;"\n                    src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${a.img_preview} " /></a>\n                          </div>\n                      </div > `),null!=a.classified_title&&$("#conversation").append(`<div class="chat-message is-received" style="background-color: transparent;"> <img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${s}" alt="Picture Profile"\n                          style="width:30px;height:30px;border-radius: 50%;"\n                          class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n                          <div class="message-block">\n                            <span>${moment(a.timestamp).format("MMM. Do h:mm")}</span>\n                            <div class="message-text"><div class="card classified-card mr-2 mb-3 justify-content-center is-flex p-2 " style="max-width: 295px">\n            <a href="/classifieds/${a.classified_slug}" style="color:black; text-decoration:none; background-color:none" class="is-flex">\n              <div class="card-img-top img-responsive column" style="max-width: 70px">\n                               <img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${a.classified_thumbnail}" alt="${a.classified_title}">\n\n              </div>\n              <div class="column">\n                <h6 class="card-title"> ${a.classified_title} </h6>\n                <p class="card-subtitle O-cl-red"> CNY ${a.classified_price} </p>\n              </div>\n            </a>\n          </div></div>\n                          </div>\n                      </div>`),null!=a.message&&$("#conversation").append(`<div class="chat-message is-received" ><img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${s}" alt="Picture Profile"\n                          style="width:30px;height:30px;border-radius: 50%;"\n                          class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n                          <div class="message-block">\n                            <span>${moment(a.timestamp).format("MMM. Do h:mm")}</span>\n                            <div class="message-text">${a.message}</div>\n                          </div>\n                      </div>`)):(null!=a.image&&$("#conversation").append(`<div class="chat-message is-sent">\n\n                          <img src="${currentUserThumbnail}" alt="Picture Profile"\n                              style="width:30px;height:30px;border-radius: 50%;"\n                              class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n                          <div class="message-block">\n                              <span>${moment(a.timestamp).format("MMM. Do h:mm")}</span>\n                              <a data-fancybox="gallery" style="width: 250px; height: 250px;"\n                href="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${a.image}"><img\n                    style="width: 250px; height: 250px;"\n                    src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${a.img_preview} " /></a>\n                          </div>\n                      </div > `),null!=a.classified_title&&$("#conversation").append(`<div class="chat-message is-sent "style="background-color: transparent;"><img src="${currentUserThumbnail}" alt="Picture Profile"\n                          style="width:30px;height:30px;border-radius: 50%;"\n                          class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n                          <div class="message-block">\n                            <span>${moment(a.timestamp).format("MMM. Do h:mm")}</span>\n                            <div class="message-text"><div class="card classified-card mr-2 mb-3 justify-content-center is-flex p-2 " style="max-width: 295px">\n            <a href="/classifieds/${a.classified_slug}" style="color:black; text-decoration:none; background-color:none" class="is-flex">\n              <div class="card-img-top img-responsive column" style="max-width: 70px">\n                <img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${a.classified_thumbnail}" alt="${a.classified_title}">\n              </div>\n              <div class="column">\n                <h6 class="card-title"> ${a.classified_title} </h6>\n                <p class="card-subtitle O-cl-red"> CNY ${a.classified_price} </p>\n              </div>\n            </a>\n          </div></div></div></div>`),null!=a.message&&$("#conversation").append(`<div class="chat-message is-sent" ><img src="${currentUserThumbnail}" alt="Picture Profile"\n                          style="width:30px;height:30px;border-radius: 50%;"\n                          class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n                          <div class="message-block">\n                            <span>${moment(a.timestamp).format("MMM. Do h:mm")}</span>\n                            <div class="message-text">${a.message}</div>\n                          </div>\n                      </div>`))})),$(".sendTo").val(e.active_username),activeUser=e.active_username,$("#conversation").scrollTop(99999999999)}})}a("active-chat")&&($("#chat-window").modal("show"),t(a("active-chat")),function(e){if(e)(function(e,s,a){if(!e&&!s)return!1;if(a){var t=new Date;t.setTime(t.getTime()+24*a*60*60*1e3);var i="; expires="+t.toGMTString()}else i="";document.cookie=e+"="+s+i+"; path=/"})(e,"",-1)}("active-chat")),$(".open-chat").click((function(){t($(this).data("url"))})),$(".delete").click((function(e){$("#conversation").html(""),$(".avatar-container").html(""),$(".username").html(""),$("body").removeClass("modal-open"),$("body").removeClass("is-frozen")})),$("textarea[name='message']").on("input selectionchange propertychange",(function(){""==$("textarea").val()?$("#addBtn").removeClass("is-hidden"):$("#addBtn").addClass("is-hidden")})),$("textarea[name='message']").on("focus",(function(e){$("#addBtn").removeClass("is-hidden"),$("#conversation").scrollTop(99999999999)})),$("#send").submit((function(e){if(e.preventDefault(),""!=$("textarea").val()){var s=`<div class="chat-message is-sent">\n\n    <img src="${currentUserThumbnail}" alt="Picture Profile" style="width:30px;height:30px;border-radius: 50%;" class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">\n\n    <div class="message-block">\n        <span>${moment().format("MMM. Do h:mm")}</span>\n\n        <div class="message-text">${$("#sendText").val()}</div>\n    </div>\n</div>`;$("#conversation").append(s),$.ajax({url:"/ws/messages/send-message/",data:$("#send").serialize(),cache:!1,type:"POST",success:function(e){$("#send")[0].reset(),$("textarea").val(""),$("textarea[name='message']").focus(),$("#conversation").scrollTop(99999999999)},fail:function(){$.wnoty({type:"error",autohide:!1,message:"failed to send the message"})}})}return!1})),$("#send-text").click((function(e){e.preventDefault(),$("#send").trigger("submit")})),$("#sendText").keypress((function(e){13!=e.which||e.shiftKey||$(".send-btn").is('[disabled="disabled"]')||($("#send").trigger("submit"),setTimeout((function(e){$("#conversation").scrollTop(99999999999)}),0))}));var i=("https:"==window.location.protocol?"wss":"ws")+"://"+window.location.host+"/ws/messages/"+currentUser+"/",r=new channels.WebSocketBridge;r.connect(i),window.onbeforeunload=function(){payload={type:"recieve",sender:currentUser,set_status:"offline",key:"set_status"},r.send(payload)},r.socket.onopen=function(){payload={type:"recieve",sender:currentUser,set_status:"online",key:"set_status"},r.send(payload)},r.socket.onclose=function(){},r.listen((function(e){switch(void 0===e.key&&(e=JSON.parse(e)),e.key){case"message":""!=activeUser&&null!=activeUser&&(e.sender===activeUser?(i=e.message_id,$.ajax({url:"/ws/messages/receive-message/",data:{message_id:i},cache:!1,success:function(e){$("#conversation").append(e),setTimeout((function(){$("#conversation").scrollTop(99999999999)}),200)}}),scrollMessages(),setTimeout((function(){$("#unread-count").hide()}),1)):$("#new-message-"+e.sender).show());break;case"set_status":s=e.sender,a=e.set_status,(t=$(".online-stat"))&&("online"===a&&s===activeUser?($(".status-light").css("color","#28a745"),t.text("online")):($(".status-light").css("color","#ffc107"),t.text("offline")))}var s,a,t,i;scrollMessages()}))}));var images,img_error,client,imgClient,uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}},Buffer=OSS.Buffer,STS=OSS.STS,FileMaxSize=13e6,ossUpload="",obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/";let retryCount=0;const retryCountMax=5;OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var s=this;$("#chooseFile, #addBtn").click((function(){document.getElementById("image-file").click()})),$('input[type="file"]').change((function(e){if(e.target.files&&e.target.files[0]){var a=new FileReader;a.onload=function(){var e=`<div class="chat-message is-sent"><img src="${currentUserThumbnail}" alt="Picture Profile" style="width:30px;height:30px;border-radius: 50%;" class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid is-hidden-mobile" id="pic"><div class="message-block"><span>${moment().format("MMM. Do h:mm")}</span><a data-fancybox="gallery" href="${a.result}"><img style="width: 250px; height: 250px;" src="${a.result}"></a></div></div>`;$("#conversation").append(e),$("#conversation").scrollTop(99999999999)},a.readAsDataURL(e.target.files[0])}var t=e.target.files,i=uploader.fileList.length,r=t.length,n=null;if($("#uploader .placeholder").hide(),$("#statusBar").css("display","flex"),0==t.length)alert("No image selected , Please select one or more images");else{for(var o=0;o<r;o++)(n=t[o]).size<=FileMaxSize?(uploader.fileList[i+o]=n,n.id=uploader.fileList[i+o].id="image"+(i+o+1),uploader.fileStats.totalFilesSize+=n.size):alert(n.name+" is larger than 13MB, please select images small than 13MB ");$(".addBtn").hide()}if(uploader.fileStats.totalFilesNum=uploader.fileList.length,0==uploader.fileStats.totalFilesNum)event.preventDefault(),alert("Please select images to upload!"),$(".start-uploader").css("display","block");else{var l=uploader.fileStats.totalFilesNum;for(o=0;o<l;o++){var c=genKey();n=uploader.fileList[o],s.uploadFile(n,c)}uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}}}})),$(".retry-upload").on("click",(function(a){e.preventDefault();for(var t=uploader.fileStats.totalFilesNum,i=0;i<t;i++){var r=genKey();file=uploader.fileList[i],s.uploadFile(file,r)}uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}}}))},uploadFile:function(e,s){$totalProgressbar.css("width","30%").html("Uploading..."),applyTokenDo().then(a=>{if(void 0!==(client=a.direct?new OSS({region:a.region,accessKeyId:a.accessId,accessKeySecret:a.stsTokenKey,bucket:a.bucket}):new OSS({region:a.region,accessKeyId:a.accessKeyId,accessKeySecret:a.accessKeySecret,stsToken:a.SecurityToken,bucket:a.bucket}))){const a=async()=>{try{return await client.multipartUpload(s,e,{progress:progress,partSize:204800,timeout:12e4}).then((function(s){$.ajax({url:obrisk_oss_url+s.name+"?x-oss-process=image/average-hue",success:function(){$("#"+e.id).children(".success-span").addClass("success"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",100==progressBarNum?$totalProgressbar.css("width",progressBar).html("Upload complete"):$totalProgressbar.css("width",progressBar).html(progressBar),$("#image").val(s.name),$.ajax({url:"/ws/messages/send-message/",data:$("#upload").serialize(),cache:!1,type:"POST",success:function(e){$("#image").val("")},fail:function(e){$("body").trigg("showRetry"),console.log(e)}})},error:function(t){retryCount<5?(retryCount++,console.error("retryCount : "+retryCount),a()):($("#"+e.id).children(".success-span").addClass("fail"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",100==progressBarNum?$totalProgressbar.css("width",progressBar).html("Upload complete"):$totalProgressbar.css("width",progressBar).html(progressBar),img_error=s.name+", Message: Corrupted image, RequestID: "+s.name,images||(images="undef,classifieds/error-img.jpg",alert("Oops! an error occured when uploading your image(s). Please try again later")))}})})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),console.log("err.request : "+e.requestId),$totalProgressbar.css("width","40%").html("Retrying..."),-1!==e.name.toLowerCase().indexOf("connectiontimeout")?retryCount<5?(retryCount++,console.error("retryCount : "+retryCount),a()):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),$("ul.filelist li").children(".success-span").addClass("fail"),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,images||(images="undef,classifieds/error-img.jpg",alert("Oops! an error occured when uploading your image(s). Please try again later"))):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,images||(images="undef,classifieds/error-img.jpg",alert("Oops! an error occured when uploading your image(s). Please try again later")))})}catch(e){alert("Oops! an error occured when uploading your image(s),                     Please try again later or contact us via support@obrisk.com. "+e),$(".start-uploader").css("display","block"),console.log(e)}};return a()}alert("Oops!, it looks like there is a network problem,             Please try again later or contact us at support@obrisk.com"),$(".start-uploader").css("display","block")}).catch(e=>{alert("Oops! an error occured before upload started, Please try again later or contact us via support@obrisk.com"+e),console.log(e)})}};var progressBar=0,progress="",$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$totalProgressbar=$("#totalProgressBar"),applyTokenDo=(progress=function(e){return function(e){$totalProgressbar.css("width",progressBar),e()}},function(){var e=oss_url;return new Promise((s,a)=>{$.ajax({url:e,success:function(e){s(e)},error:function(e){a(e)}})})});function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(){return"messages/"+currentUser+"/"+activeUser+"/"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var s=16*Math.random()|0;return("x"==e?s:3&s|8).toString(16)}))}function slugify(e){const s="àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœøṕŕßśșțùúüûǘẃẍÿź·/_,:;",a=new RegExp(s.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,"-").replace(a,e=>"aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------".charAt(s.indexOf(e))).replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}document.addEventListener("DOMContentLoaded",(function(){(ossUpload=new OssUpload).init()}));