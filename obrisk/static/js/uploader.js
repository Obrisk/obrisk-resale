var images,img_error,client,imgClient,uploader={fileList:[],fileStats:{totalFilesNum:0,totalFilesSize:0,uploadFinishedFilesNum:0,curFileSize:0}},Buffer=OSS.Buffer,STS=OSS.STS,FileMaxSize=13e6,TotalFilesMaxSize=8,ossUpload="",obrisk_oss_url="https://obrisk.oss-cn-hangzhou.aliyuncs.com/";let retryCount=0;const retryCountMax=5;OssUpload.prototype={constructor:OssUpload,bindEvent:function(){var e=this;$("#chooseFile, #addBtn").click((function(){document.getElementById("image-file").click()})),$('input[type="file"]').change((function(s){var a=s.target.files,t=uploader.fileList.length,r=a.length,i=null;$("#uploader .placeholder").hide(),$("#statusBar").css("display","flex");var o=TotalFilesMaxSize-t;if(0==o)$.wnoty({type:"error",autohide:!1,message:"Only "+TotalFilesMaxSize+" images are allowed"}),$(".addBtn").hide();else if(0==a.length)$.wnoty({type:"error",autohide:!1,message:"No image selected , Please select one or more images"});else if(r<=o&&r>0)for(var l=0;l<r;l++)(i=a[l]).size<=FileMaxSize?(uploader.fileList[t+l]=i,i.id=uploader.fileList[t+l].id="image"+(t+l+1),uploader.fileStats.totalFilesSize+=i.size,e.addFile(i)):$.wnoty({type:"error",autohide:!1,message:i.name+" is larger than 13MB, please select images small than 13MB "});else{for(l=0;l<r&&uploader.fileList.length<TotalFilesMaxSize;l++)(i=a[l]).size<=FileMaxSize?(uploader.fileList[t+l]=i,i.id=uploader.fileList[t+l].id="image"+(t+l+1),uploader.fileStats.totalFilesSize+=i.size,e.addFile(i)):$.wnoty({type:"error",autohide:!1,message:i.name+" is larger than 13MB, please select images small than 13MB "});$.wnoty({type:"error",autohide:!1,message:"Only "+TotalFilesMaxSize+" images are allowed"}),$(".addBtn").hide()}uploader.fileStats.totalFilesNum=uploader.fileList.length})),$("#startUpload").click((function(s){if(""==$("#id_title").val()||""==$("#id_details").val())s.preventDefault(),$.wnoty({type:"error",autohide:!1,message:"Please fill in the title and the details before uploading the images!"});else if(0==uploader.fileStats.totalFilesNum)s.preventDefault(),$.wnoty({type:"error",autohide:!1,message:"Please select images to upload!"}),$(".start-uploader").css("display","block");else{var a,t=uploader.fileStats.totalFilesNum;$(".start-uploader").css("display","none"),$totalProgressbar.css("width","40%").html("Upload Started please wait...");for(var r=0;r<t;r++){var i=genKey();a=uploader.fileList[r],e.uploadFile(a,i)}}})),$(".queueList .filelist").delegate("li span.cancel","click",(function(){for(var e=$(this).parent().parent(),s=e.attr("id"),a=uploader.fileList.length,t=0;t<a;t++)if(uploader.fileList[t].id==s){uploader.fileStats.totalFilesSize-=uploader.fileList[t].size,uploader.fileList.splice(t,1),uploader.fileStats.totalFilesNum=uploader.fileList.length;break}e.remove(),uploader.fileList.length<=TotalFilesMaxSize&&$(".addBtn").show()}))},uploadFile:function(e,s){$totalProgressbar.css("width","30%").html("Uploading..."),applyTokenDo().then(a=>{if(void 0!==(client=a.direct?new OSS({region:a.region,accessKeyId:a.accessId,accessKeySecret:a.stsTokenKey,bucket:a.bucket}):new OSS({region:a.region,accessKeyId:a.accessKeyId,accessKeySecret:a.accessKeySecret,stsToken:a.SecurityToken,bucket:a.bucket}))){const a=async()=>{try{return await client.multipartUpload(s,e,{progress:progress,partSize:204800,timeout:12e4}).then((function(s){$.ajax({url:obrisk_oss_url+s.name+"?x-oss-process=image/average-hue",success:function(){$("#"+e.id).children(".success-span").addClass("success"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",100==progressBarNum?$totalProgressbar.css("width",progressBar).html("Upload complete"):$totalProgressbar.css("width",progressBar).html(progressBar),images+=","+s.name},error:function(t){retryCount<5?(retryCount++,console.error("retryCount : "+retryCount),a()):($("#"+e.id).children(".success-span").addClass("fail"),$("#"+e.id).children(".file-panel").hide(),uploader.fileStats.uploadFinishedFilesNum++,uploader.fileStats.curFileSize+=e.size,progressBarNum=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2),progressBar=100*(uploader.fileStats.curFileSize/uploader.fileStats.totalFilesSize).toFixed(2)+"%",100==progressBarNum?$totalProgressbar.css("width",progressBar).html("Upload complete"):$totalProgressbar.css("width",progressBar).html(progressBar),img_error=s.name+", Message: Corrupted image, RequestID: "+s.name,images||(images="undef,classifieds/error-img.jpg",$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s).                                                 But you can submit this form without images and edit your post later to add images"})))}})})).catch(e=>{console.error(e),console.log("err.name : "+e.name),console.log("err.message : "+e.message),console.log("err.request : "+e.requestId),$totalProgressbar.css("width","40%").html("Retrying..."),-1!==e.name.toLowerCase().indexOf("connectiontimeout")?retryCount<5?(retryCount++,console.error("retryCount : "+retryCount),a()):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),$("ul.filelist li").children(".success-span").addClass("fail"),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,images||(images="undef,classifieds/error-img.jpg",$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s).                                             But you can submit this form without images and edit your post later to add images"}))):($totalProgressbar.css("width","94%").html("Completed with minor errors!"),img_error=e.name+", Message: "+e.message+", RequestID: "+e.requestId,images||(images="undef,classifieds/error-img.jpg",$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s).                                             But you can submit this form without images and edit your post later to add images"})))})}catch(e){$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured when uploading your image(s),                     Please try again later or contact us via support@obrisk.com. "+e}),$(".start-uploader").css("display","block"),console.log(e)}};return a()}$.wnoty({type:"error",autohide:!1,message:"Oops!, it looks like there is a network problem,             Please try again later or contact us at support@obrisk.com"}),$(".start-uploader").css("display","block")}).catch(e=>{$.wnoty({type:"error",autohide:!1,message:"Oops! an error occured before upload started, Please try again later or contact us via support@obrisk.com"+e}),console.log(e)})},addFile:function(e){var s,a=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="upload-state"><span></span></p><span class="success-span"></span></li>'),t=($('<div class="file-panel"><span class="cancel">cancel</span></div>').appendTo(a),a.find("p.upload-state span"),a.find("p.imgWrap"));$('<p class="error"></p>');if(/^image\//.test(e.type)){var r=document.createElement("img");r.classList.add("obj"),r.file=e,r.style.width="100%",r.style.height="100%",t.empty().append($(r));var i=new FileReader;i.onload=(s=r,function(e){s.src=e.target.result}),i.readAsDataURL(e)}a.appendTo($queue)}};var progressBar=0,progress="",$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$totalProgressbar=$("#totalProgressBar"),applyTokenDo=(progress=function(e){return console.log(e),function(e){$totalProgressbar.css("width",progressBar),e()}},function(){var e=oss_url;return new Promise((s,a)=>{$.ajax({url:e,success:function(e){s(e)},error:function(e){a(e)}})})});function OssUpload(){var e=this;e.init=function(){e.initPage(),e.bindEvent()},e.initPage=function(){}}function genKey(){return"classifieds/"+user+"/"+slugify($("#id_title").val())+"/"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var s=16*Math.random()|0;return("x"==e?s:3&s|8).toString(16)}))}function slugify(e){const s="àáäâãåăæçèéëêǵḧìíïîḿńǹñòóöôœøṕŕßśșțùúüûǘẃẍÿź·/_,:;",a=new RegExp(s.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,"-").replace(a,e=>"aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------".charAt(s.indexOf(e))).replace(/&/g,"-and-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}$((function(){(ossUpload=new OssUpload).init(),$(".create").click((function(e){images?($(".loading-modal").removeClass("d-none"),$("#create-btn").attr("disabled",!0),$("input[name='status']").val("A"),$("#id_images").val(images),$("#id_img_error").val(img_error),"on"==$("[name='phone-check']").val()?$("[name='show_phone']").prop("checked",!0):$("[name='show_phone']").prop("checked",!1),$("#classified-form").submit()):(e.preventDefault(),$.wnoty({type:"error",autohide:!1,message:"Please upload at least one image for your advertisement!"}))})),$(".draft").click((function(){$("input[name='status']").val("E"),$("#classified-form").submit()}))}));