{% load static i18n %}

{% block head %}
<script src="{% static 'js/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jquery.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/bootstrap.min.js' %}" type="text/javascript"></script>
<title>Chatting with {{ active|title}}</title>
<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'fonts/font-awesome-4.7.0/css/font-awesome.min.css' %}">
<link href="{% static 'css/messager.css' %}" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<link rel="stylesheet" href="{% static 'css/fancybox.min.css' %}" />
<script src="{% static 'js/fancybox.min.js' %}"></script>
{% endblock head %}

{% block content %}
<div class="chat">

  <div class="chat-title">
    <a class="back-btn" href="{% url 'messager:contacts_list' %}"> <i class="fa fa-chevron-left" aria-hidden="true"></i>
    </a>
    <div class="d-flex w-100 justify-content-between">
      <div class="title-avatar d-flex">
        <!--Add image -->
        {% if message.sender.thumbnail %}
        <img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{message.sender.thumbnail}}" alt="Picture Profile"
          style="width:30px;height:30px;border-radius: 50%;"
          class="rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">
        {% else %}
        <img src="{% static 'img/user.png' %}" style="border-radius: 50%;" height="30px" width="30px"
          alt="No Profile Picture" />
        {% endif %}
        <span class="user-name"> {{ active|title}} </span>
      </div>
      <div class="d-flex">
      </div>


      <div><i class="status-light fa fa-circle" aria-hidden="true"></i>
        <small class="online-stat"> Offline </small></div>


    </div>


  </div>
  <div class="messages">
    <div class="messages-content">

      {% if message_list %}
      {% if classified %}
      <div class="card classified-card mr-2 mb-3 justify-content-center d-flex p-2 " style="max-width: 295px">
        <a href="{% url 'classifieds:classified' classified.slug %}"
          style="color:black; text-decoration:none; background-color:none" class="d-flex">
          <div class="card-img-top img-responsive" style="max-width: 70px">

            {% if classified.image_thumb %}
            <img class="card-img" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.image_thumb }}">
            {% else %}
            <img class="card-img" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/classifieds/default.jpg">
            {% endif %}

          </div>
          <div class="divider"></div>
          <div class="ml-4">
            <h6 class="card-title"> {{ classified.title|truncatechars:60 }} </h6>
            <p class="card-subtitle O-cl-red"> CNY {{ classified.price|title }} </p>
            <div class="card-meta d-flex justify-content-between">
              <div class="d-flex location">
                <small>üìç</small>
                <span class="card-text small "> {{ classified.city|safe }}</span>
              </div>
            </div>

          </div>
        </a>
      </div>
      {% endif %}

      {% for message in message_list %}
      {% include 'messager/single_message.html' with message=message %}
      {% endfor %}

      {% else %}
      <strong>{% trans 'Hello '  %} {{ request.user.username| title }}{% trans ' nice to meet you' %}</strong>
      <p>{% trans "I am " %} {{ active }} {% trans ", Let's talk!" %}</p>
      {% if classified %}
      <div class="card classified-card mr-2 mb-3 justify-content-center d-flex p-2 " style="max-width: 295px">
        <a href="{% url 'classifieds:classified' classified.slug %}"
          style="color:black; text-decoration:none; background-color:none" class="d-flex">
          <div class="card-img-top img-responsive" style="max-width: 70px">

            {% if classified.image_thumb %}
            <img class="card-img" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.image_thumb }}">
            {% else %}
            <img class="card-img" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/classifieds/default.jpg">
            {% endif %}

          </div>
          <div class="divider"></div>
          <div class="ml-4">
            <h6 class="card-title"> {{ classified.title|truncatechars:60 }} </h6>
            <p class="card-subtitle O-cl-red"> CNY {{ classified.price|title }} </p>
            <div class="card-meta d-flex justify-content-between">
              <div class="d-flex location">
                <small>üìç</small>
                <span class="card-text small "> {{ classified.city|safe }}</span>
              </div>
            </div>

          </div>
        </a>
      </div>
      {% endif %}
      {% endif %}
      <div class="send-message"> </div>
    </div>
  </div>

  <div class="message-box">
    <form role="form" method="post" action="#" id="send">
      <div class="d-flex message-scroll">
        {% csrf_token %}
        <input type="hidden" name="to" value="{{ active }}">
        <textarea class="form-control mr-2" autocomplete="off" maxlength="1000" id="sendText"
          placeholder="{% trans 'Write a message...' %}" name="message" autofocus rows="2" cols="2"></textarea>

        <button class="btn send-btn  btn-dark text-white" type="submit"> <small><strong>Send</strong></small> </button>


        <a id="chooseFile" href="#" class="p-2">
          <i class="fa fa-paperclip" style="font-size: 1.2em"></i>
        </a>
      </div>

    </form>
    <form id="upload">
      {% csrf_token %}
      <input type="hidden" name="to" value="{{ active }}">
      <input id="image" type="hidden" name="image">
      <input id="image-file" type="file" style="display:none;" multiple="multiple" accept="image/*" />
    </form>
  </div>
</div>
<!-- card end-->
</div>

{% endblock content %}

{% block extra_js %}

<script type="text/javascript">
  !function () {
    var container = document.querySelector('.chat');
    var contacts = document.querySelector('.contacts');
    var messages = document.querySelector('.messages');
    var small, limiter;

    function relayout() {
      var width = window.innerWidth;
      if (!small && width < 600) {
        small = true;
        container.classList.add('small-screen');
      } else if (small && width >= 600) {
        small = false;
        container.classList.remove('small-screen');
      }
    }

    window.addEventListener('resize', function () {
      clearTimeout(limiter);
      limiter = setTimeout(relayout, 100);
    });

    relayout();
  }();

  var currentUser = "{{ request.user.username }}";
  var activeUser = "{{ active }}";
  const oss_url = "{% url 'get_oss_auth' %}";

  {% if message.sender.thumbnail %}
  var user_thumb = https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{message.sender.thumbnail}}
    {% else %}
  var user_thumb = "{% static 'img/user.png' %}"
  {% endif %}

  //This scrolls the div #messages only to the bottom
  var d = $('.messages');
  d.scrollTop(d.prop("scrollHeight"));

  //scroll when on textarea
  var div = document.querySelector('.message-scroll');
  var ta = document.querySelector('textarea');

  ta.addEventListener('keydown', autosize);

  function autosize() {
    setTimeout(function () {

      var height = Math.min(20 * 5, ta.scrollHeight);
      div.style.cssText = 'height:' + height + 'px';
      ta.style.cssText = 'height:' + height + 'px';
    }, 0);
  }

</script>

<script src="{% static 'js/websocketbridge.js' %}" type="text/javascript"></script>
<script src="{% static 'js/aliyun-oss.min.js' %}?v=3007191" type="text/javascript"></script>
<script src="{% static 'js/messager.js' %}?v=2809191" type="text/javascript"></script>
<script src="{% static 'js/bootbox.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/moment.min.js' %}"></script>
{% endblock extra_js %}