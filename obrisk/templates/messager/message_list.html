{% load static i18n %}

{% block head %}
<script src="{% static 'js/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jquery.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/bootstrap.min.js' %}" type="text/javascript"></script>
<title>Chatting with {{ active|title}}</title>
<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'fonts/font-awesome-4.7.0/css/font-awesome.min.css' %}">
<link href="{% static 'css/messager.css' %}" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
{% endblock head %}

{% block content %}
<div class="chat">
  <div class="chat-title">
    <a class="back-btn" href="{% url 'messager:contacts_list' %}"> <i class="fa fa-chevron-left" aria-hidden="true"></i>
    </a>
    <figure class="title-avatar">
    <!--Add image -->
     </figure> 

    <span class="name"> {{ active|title}} </span>
    <span class="status"> Offline </span>

  </div>
  <div class="messages">
    <div class="messages-content">
      {% if message_list %}
      {% for message in message_list %}
      {% include 'messager/single_message.html' with message=message %}
      {% endfor %}
      {% else %}
      <h5>{% trans 'Hello '  %} {{ request.user.username }}{% trans ' nice to meet you' %}</h5>
      <p>{% trans "I am " %} {{ active }} {% trans ", Let's talk!" %}</p>
      {% endif %}
      <div class="send-message"> </div>
    </div>
  </div>

  <div class="message-box">
    <form role="form" method="post" action="#" id="send">
      <div class="d-flex message-scroll">
        {% csrf_token %}
        <input type="hidden" name="to" value="{{ active }}">
        <textarea class="form-control mr-2" id="sendText" name="message" placeholder="{% trans 'Write a message...' %}"
          maxlength="1000" autofocus autocomplete="off">
        </textarea>
        <button class="btn btn-dark send-btn " type="submit"> <i class="fa fa-paper-plane-o"
            aria-hidden="true"></i></button>
      </div>
  </div>
  </form>
</div>
<!-- card end-->
</div>

{% endblock content %}

{% block extra_js %}

<script type="text/javascript">
  !function () {
    var container = document.querySelector('.chat');
    var contacts = document.querySelector('.contacts');
    var messages = document.querySelector('.messages');
    var small, limiter;

    function relayout() {
      var width = window.innerWidth;
      if (!small && width < 600) {
        small = true;
        container.classList.add('small-screen');
      } else if (small && width >= 600) {
        small = false;
        container.classList.remove('small-screen');
      }
    }

    window.addEventListener('resize', function () {
      clearTimeout(limiter);
      limiter = setTimeout(relayout, 100);
    });

    relayout();
  }();

  var currentUser = "{{ request.user.username }}";
  var activeUser = "{{ active }}";
  //This scrolls the div #messages only to the bottom
  var d = $('.messages');
  d.scrollTop(d.prop("scrollHeight"));

  //scroll when on textarea 
  var div = document.querySelector('.message-scroll');
  var ta = document.querySelector('textarea');

  ta.addEventListener('keydown', autosize);

  function autosize() {
    setTimeout(function () {

      var height = Math.min(20 * 5, ta.scrollHeight);
      div.style.cssText = 'height:' + height + 'px';
      ta.style.cssText = 'height:' + height + 'px';
    }, 0);
  }
</script>
<script src="{% static 'js/websocketbridge.js' %}" type="text/javascript"></script>
<script src="{% static 'js/messager.js' %}" type="text/javascript"></script>
{% endblock extra_js %}