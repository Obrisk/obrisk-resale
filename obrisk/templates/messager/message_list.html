{% load static i18n %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>Chatting with {{ active.username|title}}</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:600,700,800,900" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,500" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/messages.css' %}">
<link rel="stylesheet" href="{% static 'css/vendor/fancybox.min.css' %}">

<!-- Core CSS 
<link href="{% static 'frontend/assets/css/webfont.css' %}" rel="stylesheet">
-->
{% endblock head %}

{% block content %}

<body class="has-slimscroll">


  <!-- Pageloader -->
  <div class="pageloader"></div>
  <div class="infraloader is-active"></div>

  <div class="chat-wrapper is-standalone">
    <div class="chat-inner">

      <!-- Chat top navigation -->
      <div class="chat-nav">
        <div class="nav-start">
          <div class="recipient-block">
            <div class="avatar-container">
              <!--Add image -->
              {% if active.thumbnail %}
              <img src="{{oss}}/{{active.thumbnail}}" alt="Picture Profile"
                style="width:30px;height:30px;border-radius: 50%;"
                class=" user-avatar rounded-circle  mb-3 mb-md-0 mr-md-3 profile-header-avatar img-fluid" id="pic">
              {% else %}
              <img src="{% static 'img/user.png' %}" style="border-radius: 50%;" height="30px" width="30px"
                class="user-avatar" alt="No Profile Picture" />
              {% endif %}
            </div>
            <div class="username">
              <span>{{ active.username|title}}</span>
              </span></span>
            </div>
          </div>
        </div>
        <div class="nav-end">

          <div>
            <a class="chat-nav-item is-icon" href="/ws/messages/">
              <i data-feather="delete"></i>
            </a>
          </div>

        </div>
      </div>


      <!-- Chat body -->
      <div id="chat-body" class="chat-body">
        <!-- Conversation with Dan -->
        <div id="conversation" class="chat-body-inner has-slimscroll">

          {% if message_list %}
              {% if classified %}
              <div class="card classified-card mr-2 mb-3 justify-content-center is-flex p-2 " style="max-width: 295px">
                <a href="{% url 'classifieds:classified' classified.slug %}"
                  style="color:black; text-decoration:none; background-color:none" class="is-flex">
                  <div class="card-img-top img-responsive column" style="max-width: 70px">

                    {% if classified.image_thumb %}
                    <img class="card-img" src="{{oss}}/{{ classified.image_thumb }}">
                    {% else %}
                    <img class="card-img" src="{{oss}}/classifieds/default.jpg">
                    {% endif %}

                  </div>
                  <div class="column">
                    <h6 class="card-title"> {{ classified.title|truncatechars:60 }} </h6>
                    <p class="card-subtitle O-cl-red"> CNY {{ classified.price|title }} </p>
                    <div class="card-meta is-flex justify-content-between">
                      <div class="is-flex location">
                        {%if classified.city %}
                        <small>üìç</small>
                        <span class="card-text small "> {{ classified.city|safe }}</span>
                        {%endif%}
                      </div>
                    </div>

                  </div>
                </a>
              </div>
              {% endif %}

              {% for message in message_list %}
                  {% include 'messager/single_message.html' with message=message %}
              {% endfor %}

      {% else %}
          <strong>{% trans 'Hello '  %} {{ request.user.username| title }}{% trans ' nice to meet you' %}</strong>
          <p>{% trans "I am " %} {{ active.username }} {% trans ", Let's talk!" %}</p>

          {% if classified %}
          <div class="card classified-card mr-2 mb-3 justify-content-center is-flex p-2 " style="max-width: 295px">
            <a href="{% url 'classifieds:classified' classified.slug %}"
              style="color:black; text-decoration:none; background-color:none" class="is-flex">
              <div class="card-img-top img-responsive column" style="max-width: 70px">

                {% if classified.image_thumb %}
                <img class="card-img" src="{{oss}}/{{ classified.image_thumb }}">
                {% else %}
                <img class="card-img" src="{{oss}}/classifieds/default.jpg">
                {% endif %}

              </div>
              <div class="column">
                <h6 class="card-title"> {{ classified.title|truncatechars:60 }} </h6>
                <p class="card-subtitle O-cl-red"> CNY {{ classified.price|title }} </p>
                <div class="card-meta is-flex justify-content-between">
                  <div class="is-flex location">
                    {%if classified.city %}
                    <small>üìç</small>
                    <span class="card-text small "> {{ classified.city|safe }}</span>
                    {%endif%}
                  </div>
                </div>

              </div>
            </a>
          </div>
          {% endif %}
      {% endif %}

      <div class="send-message"> </div>
    </div>

        <!-- Compose message area -->
        <div class="chat-action">
          <div class="message-box">


            <div class="chat-action-inner">
              <div class="control">
                <form role="form" method="post" action="#" id="send">
                  <div class="is-flex message-scroll">
                    {% csrf_token %}
                    <input type="hidden" name="to" value="{{ active.username }}">
                    <textarea class="form-control mr-2 textarea comment-textarea" autocomplete="off" maxlength="1000"
                      id="sendText" placeholder="{% trans 'Write a message...' %}" name="message" autofocus rows="2"
                      cols="2"></textarea>


                    <a id="chooseFile" href="#" class="p-2">
                      <i class="fa fa-paperclip" style="font-size: 1.2em"></i>
                    </a>
                  </div>

                </form>
                <form id="upload">
                  {% csrf_token %}
                  <input type="hidden" name="to" value="{{ active.username }}">
                  <input id="image" type="hidden" name="image">
                  <input id="image-file" type="file" style="display:none;" multiple="multiple" accept="image/*" />

                  <div class="dropdown compose-dropdown is-spaced is-accent is-up dropdown-trigger">
                    <div class="is-flex">
                      <div class="add-button" id="addBtn">
                        <div class="button-inner">
                          <i class="mdi mdi-camera" style="color: white;"></i>
                        </div>
                      </div>
                      <button id="send-text" class="add-button button is-solid accent-button is-bold raised"
                        type="submit">
                        <small><strong>Send</strong></small>
                      </button>

                    </div>

                  </div>
                </form>

              </div>

            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</body>

<!-- Core js 
<script src="{% static 'js/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/vendor/fancybox.min.js' %}"></script>
-->
{% endblock content %}

{% block extra_js %}

<script type="text/javascript">

  var currentUser = "{{ request.user.username }}";
  var activeUser = "{{ active.username }}";
  const oss_url = "{% url 'get_oss_auth' %}";

  {% if message.sender.thumbnail %}
  var user_thumb = "{{oss}}/{{message.sender.thumbnail}}"
    {% else %}
  var user_thumb = "{% static 'img/user.png' %}"
  {% endif %}

  //This scrolls the div #messages only to the bottom
  var d = $('#conversation');
  d.scrollTop(d.prop("scrollHeight"));

  //scroll when on textarea
  var div = document.querySelector('.message-scroll');
  var ta = document.querySelector('textarea');

  ta.addEventListener('keydown', autosize);

  function autosize() {
    setTimeout(function () {

      var height = Math.min(20 * 5, ta.scrollHeight);
      div.style.cssText = 'height:' + height + 'px';
      ta.style.cssText = 'height:' + height + 'px';
    }, 0);
  }

</script>

<script src="{% static 'js/vendor/jquery.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/vendor/aliyun-oss.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/vendor/messager.js' %}" type="text/javascript"></script>
<script src="{% static 'js/vendor/moment.min.js' %}"></script>
{% endblock extra_js %}
