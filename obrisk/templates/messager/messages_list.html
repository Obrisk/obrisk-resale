{% load static i18n %}

{% block head %}
<link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>Chatting with {{active.username|title}}</title>
<!-- Fonts -->
<link rel="stylesheet" href="{% static 'css/bulma.css' %}">
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

{% endblock head %}

{% block content %}
<body class="has-slimscroll">
    <div id="chat-window">
      <div class="chat-wrapper is-standalone">
        <div class="chat-inner">

          <!-- Chat top navigation -->
          <div class="chat-nav">
            <div class="nav-start">
              <div class="recipient-block">
                <div class="avatar-container">
                  {% if message.sender.thumbnail %}
                        <img class="user-avatar rounded-circle profile-header-avatar img-fluid"
                        id="pic" alt="pic" src="{{oss}}/{{message.sender.thumbnail}}">
                  {% else %}
                        <img class="user-avatar rounded-circle profile-header-avatar img-fluid"
                        id="pic" alt="pic" src="{% static 'img/user.png' %}">
                  {% endif %}
                </div>
                <div class="username">
                    <span> {{ active.username | title }} </span>
                </div>
              </div>
            </div>
            <div class="nav-end">
              <div>
                <a href="{% url 'messager:contacts_list' %}"
                   class="delete is-large" aria-label="close">
                </a>
              </div>
            </div>
          </div>

          <!-- Chat body -->
          <div id="chat-body" class="chat-body" style="">
            <!-- Conversation with Dan -->
            <div id="conversation" class="chat-body-inner" style="flex-grow: 1;">

              {% if messages_list %}
                  {% if classified %}
                  <div class="card classified-card mr-2 mb-3 justify-content-center is-flex p-2 " style="max-width: 295px">
                    <a href="{% url 'classifieds:classified' classified.slug %}"
                      style="color:black; text-decoration:none; background-color:none" class="is-flex">
                      <div class="card-img-top img-responsive column" style="max-width: 70px">

                        {% if classified.image_thumb %}
                        <img class="card-img" src="{{oss}}/{{ classified.image_thumb }}">
                        {% else %}
                        <img class="card-img" src="{{oss}}/classifieds/default.jpg">
                        {% endif %}

                      </div>
                      <div class="column">
                        <h6 class="card-title"> {{ classified.title|truncatechars:60 }} </h6>
                        <p class="card-subtitle O-cl-red"> CNY {{ classified.price|title }} </p>
                        <div class="card-meta is-flex justify-content-between">
                          <div class="is-flex location">
                            {%if classified.city %}
                            <small>üìç</small>
                            <span class="card-text small "> {{ classified.city|safe }}</span>
                            {%endif%}
                          </div>
                        </div>

                      </div>
                    </a>
                  </div>
                  {% endif %}

                  {% for message in messages_list %}
                      {% include 'messager/single_message.html' with message=message %}
                  {% endfor %}

          {% else %}
              <strong>{% trans 'Hello '  %} {{ request.user.username| title }}{% trans ' nice to meet you' %}</strong>
              <p>{% trans "I am " %} {{ active.username }} {% trans ", Let's talk!" %}</p>

              {% if classified %}
              <div class="card classified-card mr-2 mb-3 justify-content-center is-flex p-2 " style="max-width: 295px">
                <a href="{% url 'classifieds:classified' classified.slug %}"
                  style="color:black; text-decoration:none; background-color:none" class="is-flex">
                  <div class="card-img-top img-responsive column" style="max-width: 70px">

                    {% if classified.image_thumb %}
                    <img class="card-img" src="{{oss}}/{{ classified.image_thumb }}">
                    {% else %}
                    <img class="card-img" src="{{oss}}/classifieds/default.jpg">
                    {% endif %}

                  </div>
                  <div class="column">
                    <h6 class="card-title"> {{ classified.title|truncatechars:60 }} </h6>
                    <p class="card-subtitle O-cl-red"> CNY {{ classified.price|title }} </p>
                    <div class="card-meta is-flex justify-content-between">
                      <div class="is-flex location">
                        {%if classified.city %}
                        <small>üìç</small>
                        <span class="card-text small "> {{ classified.city|safe }}</span>
                        {%endif%}
                      </div>
                    </div>

                  </div>
                </a>
              </div>
              {% endif %}
          {% endif %}

          <div class="send-message"> </div>
          </div>

            <!-- Compose message area -->
            <div class="chat-action" style="z-index: 9999;position: relative; bottom: 0;">
              <div class="message-box">

                <div class="chat-action-inner">
                  <div class="control">
                    <form role="form" method="post" action="#" id="send">
                      <div class="is-flex message-scroll">
                        {% csrf_token %}
                        <input type="hidden" class="sendTo" name="to" value="">
                        <textarea class="form-control textarea comment-textarea" autocomplete="off"
                          maxlength="1000" id="sendText" placeholder="{% trans 'Write a message...' %}" name="message"
                          autofocus rows="2" cols="2"></textarea>
                      </div>

                    </form>
                    <form id="upload">
                      {% csrf_token %}
                      <!-- input type="hidden" name="to" value="{{ active.username }}"-->
                      <input type="hidden" name="to" value="" class="sendTo">
                      <input id="image" type="hidden" name="image">
                      <input id="image-file" type="file" style="display:none;" multiple="multiple" accept="image/*" />

                      <div class="dropdown compose-dropdown is-spaced is-accent is-up dropdown-trigger">
                        <div class="is-flex">
                          <div class="add-button" id="addBtn">
                            <div class="button-inner">
                                <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"
                                    viewBox="0 0 512 512">
                                    <path d="M456,64H56A24,24,0,0,0,32,88V424a24,24,0,0,0,24,24H456a24,24,0,0,0,24-24V88A24,24,0,0,0,456,64ZM331.62,128.2a48,48,0,1,1-43.42,43.42A48,48,0,0,1,331.62,128.2ZM76,416a12,12,0,0,1-12-12V316.37L192.64,202l96.95,96.75L172.37,416Zm372-12a12,12,0,0,1-12,12H217.63L367.16,266.47,448,333.84Z"/>
                                </svg>
                            </div>
                          </div>

                          <button id="send-text"
                            class="button add-button is-solid accent-button is-bold raised">
                            <small><strong>Send</strong></small>
                          </button>

                        </div>

                      </div>
                    </form>

                  </div>

                </div>
              </div>
            </div>
    </div>
  </div>
</body>

{% endblock content %}

{% block extra_js %}

<script type="text/javascript">

  var currentUser = "{{ request.user.username }}";
  var activeUser = "{{ active.username }}";
  const oss_url = "{% url 'get_oss_auth' %}";

  //This scrolls the div #messages only to the bottom
  var d = document.getElementById('conversation');
  d.scrollTop = d.getAttribute("scrollHeight");

  //scroll when on textarea
  var div = document.querySelector('.message-scroll');
  var ta = document.querySelector('textarea');

  ta.addEventListener('keydown', autosize);

  function autosize() {
    setTimeout(function () {

      var height = Math.min(20 * 5, ta.scrollHeight);
      div.style.cssText = 'height:' + height + 'px';
      ta.style.cssText = 'height:' + height + 'px';
    }, 0);
  }

</script>

<script async defer src="{% static 'js/vendor/fslightbox.min.js' %}"></script>
<script defer src="{% static 'js/vendor/dayjs.min.js' %}"></script>
<script src="{% static 'js/vendor/aliyun-oss.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/websocketbridge.js' %}" type="text/javascript"></script>
<script src="{% static 'js/messager.js' %}" type="text/javascript"></script>
{% endblock extra_js %}
