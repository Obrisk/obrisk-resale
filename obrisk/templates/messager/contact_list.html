{% extends "base.html" %}
{% load static i18n %}

{% block head %}
<link href="{% static 'css/chat.css' %}" rel="stylesheet">
<title>{% trans 'Messages' %}</title>
{% endblock head %}

{% block content %}
    <h1 class="title is-5"> {% trans 'Recent Messages' %} </h1>

    <div class="users-list">
      {% for con in convs %}
          {% if con.first_user.username == request.user.username %}
              <a href="#chat-window" data-toggle="modal"
                data-url="{% url 'messager:conversation_detail' con.second_user.username %}"
                class="card contact-card open-chat">
                {% if con.second_user.thumbnail %}
                <img src="{{oss}}/{{con.second_user.thumbnail}}" alt="Pic" width="40px"
                  style="width:40px;height:40px;border-radius: 50%;"
                  class="rounded-circle profile-header-avatar img-fluid">
                {% else %}
                <img src="{% static 'img/user.png' %}" width="40px" style="width:40px;height:40px;border-radius: 50%;"
                  alt="No Pic" class="profile-header-avatar img-fluid" />
                {% endif %}

                <div class="contact-card-meta">
                  <div class="name-time-section">
                      <div> <strong> {{ con.second_user.get_profile_name|title }} </strong> </div>
                      <div> <small> {{ con.time|date:'N d G:i' }} </small> </div>
                  </div>

                  {% if con.last_msg %}
                      <small> {{ con.last_msg|truncatechars:50 }} </small>
                  {% elif con.img or con.attachment %}
                      <small> Attachment </small>
                  {% else %}
                      <small> New conversation </small>
                  {% endif %}

                  {%  if con.unread and request.user.id == con.recipient %}
                      <span id="new-msgs"> <i class="fa fa-circle" aria-hidden="true"></i> </span>
                  {% endif %}
                </div>
              </a>

          {% else %}
              <a href="#chat-window" data-toggle="modal"
                data-url="{% url 'messager:conversation_detail' con.first_user.username %}"
                class="card contact-card open-chat">
                {% if con.first_user.thumbnail %}
                <img src="{{oss}}/{{con.first_user.thumbnail}}" alt="Picture Profile"
                  style="width:40px;height:40px;border-radius: 50%;"
                  class="rounded-circle profile-header-avatar img-fluid" id="pic">
                {% else %}
                <img src="{% static 'img/user.png' %}" height="40px" style="width:40px;height:40px;border-radius: 50%;"
                  alt="No Profile Picture" class="profile-header-avatar img-fluid" />
                {% endif %}

                <div class="contact-card-meta">
                  <div class="name-time-section">
                    <strong> {{ con.first_user.get_profile_name|title }} </strong>
                    <small> {{ con.time|date:'N d G:i' }} </small>
                  </div>

                  {% if con.last_msg %}
                      <small> {{ con.last_msg|truncatechars:50 }} </small>
                  {% elif con.img or con.attachment %}
                      <small> Attachment </small>
                  {% else %}
                      <small> New conversation </small>
                  {% endif %}

                  {%  if con.unread and request.user.id == con.recipient %}
                      <span id="new-msgs"> <i class="fa fa-circle" aria-hidden="true"></i> </span>
                  {% endif %}
                </div>
              </a>
          {% endif %}

      {% empty %}

          <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="background-color: #3EC4E2;">
              <li class="breadcrumb-item">
                <h4> {% trans "No contacts" %} </h4>
              </li>
            </ol>
          </nav>

          <p>
            {% trans "Go to discover and send friend requests or invite your friends, Or chat with Obrisk team members" %}
          </p>

          <a href="#chat-window" data-toggle="modal"
            data-url="{% url 'messager:conversation_detail' super_users.first.username %}"
            class="card flex-row open-chat ">
            {% if super_users.first.thumbnail %}
                <img src="{{oss}}/{{super_users.first.thumbnail}}" alt="Picture Profile"
                  style="width:40px;height:40px;border-radius: 50%;"
                  class="rounded-circle profile-header-avatar img-fluid" id="pic">
            {% else %}
                <img src="{% static 'img/user.png' %}" width="40px" alt="No Profile Picture"
                  class="profile-header-avatar img-fluid" />
            {% endif %}

            <strong> {{ super_users.first.get_profile_name|title }} </strong> </a>

      {% endfor %}
      </div>

      <div class="action-buttons">

          <a onclick="shareMe()" class="button is-solid accent-button">
            {% trans "Invite Friends" %}
          </a>

          <a href="{% url 'connections:friendship_view_friends' %}" 
              class="button is-solid accent-button">
            {% trans "Discover" %}
          </a>
      </div>

      </div>
    </div>

    <div id="chat-window" class="modal">

      <div class="chat-wrapper is-standalone">
        <div class="chat-inner">

          <!-- Chat top navigation -->
          <div class="chat-nav">
            <div class="nav-start">
              <div class="recipient-block">
                <div class="avatar-container">
                  <!--Add image -->
                </div>
                <div class="username">


                </div>
              </div>
            </div>
            <div class="nav-end">

              <div>
                <button data-toggle="modal" data-target="#chat-window" class="delete is-large"
                  aria-label="close"></button>
              </div>

            </div>
          </div>

          <!-- Chat body -->
          <div id="chat-body" class="chat-body" style="display: flex;height: 100vh;flex-direction: column;">
            <!-- Conversation with Dan -->
            <div id="conversation" class="chat-body-inner has-slimscroll" style="flex-grow: 1;">

              <div class="send-message"> </div>
            </div>
            <!-- Compose message area -->
            <div class="chat-action" style="z-index: 9999;position: relative; bottom: 0;">
              <div class="message-box">


                <div class="chat-action-inner">
                  <div class="control">
                    <form role="form" method="post" action="#" id="send">
                      <div class="is-flex message-scroll">
                        {% csrf_token %}
                        <input type="hidden" class="sendTo" name="to" value="">
                        <textarea class="form-control textarea comment-textarea" autocomplete="off"
                          maxlength="1000" id="sendText" placeholder="{% trans 'Write a message...' %}" name="message"
                          autofocus rows="2" cols="2"></textarea>


                        <a id="chooseFile" href="#">
                          <i class="fa fa-paperclip" style="font-size: 1.2em"></i>
                        </a>
                      </div>

                    </form>
                    <form id="upload">
                      {% csrf_token %}
                      <input type="hidden" name="to" value="" class="sendTo">
                      <input id="image" type="hidden" name="image">
                      <input id="image-file" type="file" style="display:none;" multiple="multiple" accept="image/*" />

                      <div class="dropdown compose-dropdown is-spaced is-accent is-up dropdown-trigger">
                        <div class="is-flex">
                          <div class="add-button" id="addBtn">
                            <div class="button-inner">
                              <i class="mdi mdi-camera" style="color: white;"></i>
                            </div>
                          </div>
                          <button id="send-text"
                            class="add-button button is-hidden-mobile is-solid accent-button is-bold raised">
                            <small><strong>Send</strong></small>
                          </button>

                        </div>

                      </div>
                    </form>

                  </div>

                </div>
              </div>
            </div>

          </div>
{% endblock content %}

{% block extra_js %}
    <link rel="stylesheet" href="{% static 'css/share.css' %}">

    <script>
      var activeUser = "{{ active }}";
      var currentUser = "{{ request.user.username }}";

      {% if request.user.thumbnail %}
          var currentUserThumbnail = "{{oss}}/{{ request.user.thumbnail }}"
      {% else %}
          var currentUserThumbnail = "{{oss}}/{% static 'img/user.png' %}"
      {% endif %}

      const oss_url = "{% url 'get_oss_auth' %}";

      {% if active.thumbnail %}
          var user_thumb = "{{oss}}/{{ active.thumbnail }}"
      {% else %}
          var user_thumb = "{% static 'img/user.png' %}"
      {% endif %}

      function shareMe() {
        navigator.share({
          title: 'Join Obrisk Today!',
          text: "Checkout Obrisk.com, social network for foreigners in China",
          url: 'https://obrisk.com/',
        })
      }
    </script>

    <script src="{% static 'js/vendor/aliyun-oss.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/vendor/jquery.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/modal.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/messager.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/vendor/moment.min.js' %}"></script>
    <script src="{% static 'js/share.js' %}" type="text/javascript"></script>
{% endblock extra_js %}
