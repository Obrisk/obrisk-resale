{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load socialaccount %}
{% load crispy_forms_tags %}
{% get_providers as socialaccount_providers %}
{% block head %}
<title>{% trans 'Account Login' %}</title>
<link rel="stylesheet" type="text/css" href="{% static 'fonts/Linearicons-Free-v1.0.0/icon-font.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/util.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/login.css' %}">
<link rel="stylesheet" href="{% static 'css/wnoty.css' %}">
{% endblock head %}

{% block content %}
<div class="view-wrapper">
  <div class="container">
    <div id="" class="view-wrap true-dom">
      <div class="columns is-centered">


        <div class="column is-half is-one-third-desktop has-background-white p-4 text-center">

          <dis class="is-flex row">
            <span class="login100-form-title p-b-32 col-12 ">{% trans 'Account Login' %}</span>

            <span class="errors col-12"></span>
          </dis>

          <!--Login Form-->
          <div class="hero-body p-0">
            <div class="form-wrapper">
              <!--Form-->
              <div class="login-form">

                <div class="login-wrapper">
                  <div class="outer-panel">
                    <div class="outer-panel-inner">

                      <form class="login" method="POST" action="{% url 'account_login' %}">
                        {% csrf_token %}
                        <div id="signup-panel-1" class="process-panel-wrap is-narrow is-active ">
                          <div class="form-panel">
                            <div class="form-row mt-3">
                              <div class="form-group col-md-12 mb-0">
                                <div class="input-group">
                                  <label for="phone_number">
                                      {% trans 'Phone number / Username / Email' %}
                                  </label>
                                </div>
                                {{ form.login }}
                              </div>
                            </div>
                            <div class="form-row">

                              <div class="form-group col-md-12 mb-0">
                                <div class="input-group">
                                  <label for="password">
                                      {% trans 'Password' %}
                                  </label>
                                </div>
                                {{ form.password }}
                              </div>
                            </div>

                          </div>
                          {% if redirect_field_value %}
                          <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
                          {% endif %}
                          <div class="form-group container-login100-form-btn mt-3">
                            <button type="submit"
                              class="button is-rounded is-solid accent-button raised is-fullwidth ">{% trans 'Login' %}</button>
                          </div>
                          <div class="form-group container-login100-form-btn d-flex justify-content-between">
                            <a href="{% url 'account_signup' %}"
                              class="button is-solid dark-grey-button raised">{% trans 'Sign up' %}</a>
                            <a href="{% url 'users:phone_password_reset' %}"
                              class="button is-solid dark-grey-button raised">{% trans 'Reset Password' %}</a>
                          </div>

                        </div>
                      </form>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>

          <div> <small class="mt-5" id="support"> 
                  {% trans 'Login problem?' %}
              <a class="blue-link" href="mailto:support@obrisk.com">
                  {% trans 'click here ' %}
              </a> 
              {% trans 'to contact us or add WechatID:' %}
              <span class="blue-link"> Obrisk. </span> </small> </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>

  var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

  window.mobileUtil = (function (win, doc) {
    var UA = navigator.userAgent,
      isAndroid = /android|adr/gi.test(UA),
      isIOS = /iphone|ipod|ipad/gi.test(UA) && !isAndroid,
      isBlackBerry = /BlackBerry/i.test(UA),
      isWindowPhone = /IEMobile/i.test(UA),
      isMobile = isAndroid || isIOS || isBlackBerry || isWindowPhone;
    return {
      isAndroid: isAndroid,
      isIOS: isIOS,
      isMobile: isMobile,
      isWeixin: /MicroMessenger/gi.test(UA),
      isQQ: /QQ/gi.test(UA)
    };
  })(window, document);
  const isInStandaloneMode = () =>
    (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone);


  //NOTE!!!
  //This auto-login mechanism is a quick hack around to solve the problem of iOS 11 and weixin browsers
  //There could be security risks in the future therefore not recommended as permanent fix
  //All the variables with /stories URL represents the login url where the user will be redirected
  //after a successful login
  if (mobileUtil.isWeixin || mobileUtil.isIOS) {
    if (!localStorage.getItem('auth')) {
      //When user click on login save the auth details only after successfull ajax login then redirect
      //else allow user to retry login
      $('.login100-form-btn').click(function (event) {
        event.preventDefault();
        var username = $('[name="login"]').val();
        var pass = $('[name="password"]').val();

        var ajax = new XMLHttpRequest();
        ajax.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            //This condition marks false while things are true
            if (this.responseURL && /stories/gi.test(this.responseURL)) {
              var auth = {
                username: username,
                password: pass
              }
              localStorage.setItem('autologintry', false);
              localStorage.setItem('auth', JSON.stringify(auth))

              if (navigator.storage && navigator.storage.persist)
                navigator.storage.persisted().then(persistent => {
                  if (persistent)
                    console.log("Storage will not be cleared except by explicit user action");
                  else
                    console.log("Storage may be cleared by the UA under storage pressure.");
                });
              if (navigator.storage && navigator.storage.persist)
                navigator.storage.persist().then(granted => {
                  if (granted)
                    console.log("Storage will not be cleared except by explicit user action");
                  else
                    console.log("Storage may be cleared by the UA under storage pressure.");
                });
              location.replace('/stories')
            }
            else {
              $.wnoty({
                type: "error",
                autohide: false,
                message: 'Failed to login, please verify your username or password'
              });
            }
          }
        }

        ajax.open("POST", "/auth/login/");
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        ajax.send("csrfmiddlewaretoken=" + csrftoken + "&login=" + username + "&password=" + pass);

      })

    }
    else {

      var dialog = $.wnoty({
        type: "info",
        message: '<p class="text-center mb-0"><i class="fa fa-spin fa-cog"></i> Autologin</p>',
      });

      var auth = JSON.parse(localStorage.getItem('auth'));
      var ajax = new XMLHttpRequest();
      ajax.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          console.log('autologin');
          if (this.responseURL && /stories/gi.test(this.responseURL)) {

            location.replace('/stories')

          } else {
            //try auto login only once
            localStorage.setItem('autologintry', true);
            alert('Autologin failed please try manual login');
            location.replace('/auth/login/');
          }
        }
      }
      var auth = JSON.parse(localStorage.getItem('auth'));
      ajax.open("POST", "/auth/login/");
      ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      ajax.send("csrfmiddlewaretoken=" + csrftoken + "&login=" + auth.username + "&password=" + auth.password);
    }

  }

  {% if form.errors %}
  $(".errors").append(`<small class="pass-text" style="color: #ff5f59;">The phone number/username or password you specified are not correct.</small>`)
  {% endif %}

</script>
<script src="{% static 'js/wnoty.js' %}" type="text/javascript"></script>

{% endblock content %}
