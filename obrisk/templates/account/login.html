{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load account socialaccount %}
{% load crispy_forms_tags %}
{% get_providers as socialaccount_providers %}
{% block head %}
<title>{% trans 'Account Login' %}</title>
<link rel="stylesheet" type="text/css" href="{% static 'fonts/Linearicons-Free-v1.0.0/icon-font.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/util.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/login.css' %}?v=1908191">
<script src="{% static 'js/bootbox.min.js' %}" type="text/javascript"></script>

{% endblock head %}

{% block content %}


<div class="limiter">
  <button onclick="window.history.go(-1); return false;" class="d-sm-block d-md-none btn btn-dark"> <i
      class="fa fa-chevron-left" aria-hidden="true"></i></button>
  <div class="container-login100">
    <div class="wrap-login100 p-l-85 p-r-85 p-t-30 p-b-55">
      <span class="login100-form-title p-b-32">{% trans 'Account Login' %}</span>
      <span class="txt3">
        {% if socialaccount_providers %}
        <p>{% blocktrans with site.name as site_name %}Please sign in with one
          of your existing third party accounts. Or, sign up for a {{ site_name }}
          account and sign in below:{% endblocktrans %}</p>
        <div class="socialaccount_ballot">
          <ul class="socialaccount_providers">
            {% include "socialaccount/snippets/provider_list.html" with process="login" %}
          </ul>
          <div class="login-or">{% trans 'or' %}</div>
        </div>
        {% include "socialaccount/snippets/login_extra.html" %}
        {% else %}
        <p>If you have not created an account yet, then please
          <a href="{% url 'account_signup' %}">{% trans 'sign up first.' %}</a> </p>
        {% endif %}
      </span>
      <form class="login" method="POST" action="{% url 'account_login' %}">
        {% csrf_token %}
        {{ form|crispy }}
        {% if redirect_field_value %}
        <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
        {% endif %}
        <div class="form-group container-login100-form-btn">
          <button type="submit" class="login100-form-btn">{% trans 'Login' %}</button>
        </div>
        <div class="form-group container-login100-form-btn d-flex justify-content-between">
          <a href="{% url 'account_signup' %}" class="btn btn-link">{% trans 'Sign up' %}</a>
          <a href="{% url 'users:phone_password_reset' %}"
            class="btn btn-link float-right">{% trans 'Forgot Username or password?' %}</a>
        </div>
      </form>

      <div> <small class="mt-5" id="support"> If you have any problem with signing up, Please
          <a href="mailto:support@obrisk.com"> click here </a> to contact us or on WechatID:
          <span style="font-weight:bold; color: #0aeee3"> Obrisk. </span> </small> </div>

    </div>
  </div>
</div>

<script>

  var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

  window.mobileUtil = (function (win, doc) {
    var UA = navigator.userAgent,
      isAndroid = /android|adr/gi.test(UA),
      isIOS = /iphone|ipod|ipad/gi.test(UA) && !isAndroid,
      isBlackBerry = /BlackBerry/i.test(UA),
      isWindowPhone = /IEMobile/i.test(UA),
      isMobile = isAndroid || isIOS || isBlackBerry || isWindowPhone;
    return {
      isAndroid: isAndroid,
      isIOS: isIOS,
      isMobile: isMobile,
      isWeixin: /MicroMessenger/gi.test(UA),
      isQQ: /QQ/gi.test(UA)
    };
  })(window, document);
  const isInStandaloneMode = () =>
    (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone);



  if (true) {
    if (!localStorage.getItem('auth')) {


      //When user click on login save the auth details only after successfull ajax login then redirect
      //else allow user to retry login
      $('.login100-form-btn').click(function (event) {
        event.preventDefault();
        var username = $('[name="login"]').val();
        var pass = $('[name="password"]').val();

        var ajax = new XMLHttpRequest();
        ajax.onreadystatechange = function () {
          if (this.readyState == 4 && /classifieds/gi.test(this.responseURL)) {
            var auth = {
              username: username,
              password: pass
            }
            localStorage.setItem('autologintry', false);
            localStorage.setItem('auth', JSON.stringify(auth))
            if (localStorage.getItem('lastURL') == "/" || null || undefined) {
              location.replace('/classifieds')
            } else {
              location.replace(localStorage.getItem('lastURL'))

            }
          } else {
            alert('Login failed, please check your username and password!');
          }
        }
        ajax.open("POST", "/accounts-authorization/login/");
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        ajax.send("csrfmiddlewaretoken=" + csrftoken + "&login=" + username + "&password=" + pass);

      })

    }
    else {

      //auto login if we have auth save in localStorage
      if (!localStorage.getItem('autologintry') || localStorage.getItem('autologintry') == false) {

        var dialog = bootbox.dialog({
          message: '<p class="text-center mb-0"><i class="fa fa-spin fa-cog"></i> Autologin</p>',
          closeButton: false
        });

        var auth = JSON.parse(localStorage.getItem('auth'));
        var ajax = new XMLHttpRequest();
        ajax.onreadystatechange = function () {
          if (this.readyState == 4 && /classifieds/gi.test(this.responseURL)) {
            if (localStorage.getItem('lastURL') == "/" || null || undefined) {
              location.replace('/classifieds')
            } else {
              location.replace(localStorage.getItem('lastURL'))
            }
          } else {
            //try auto login only once
            localStorage.setItem('autologintry', true);
            alert('Autologin failed please try manual login');
            location.replace('/accounts-authorization/login/');
          }
        }

        var auth = JSON.parse(localStorage.getItem('auth'));
        ajax.open("POST", "/accounts-authorization/login/");
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        ajax.send("csrfmiddlewaretoken=" + csrftoken + "&login=" + auth.username + "&password=" + auth.password);
      }
    }
  }

</script>

{% endblock content %}