{% extends 'base.html' %}
{% load static i18n %}
{% load crispy_forms_tags %}
{% load cloudinary %}

{% block head %}
{% endblock head %}

{% block content %}

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'posts:list' %}">{% trans 'Home' %}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'classifieds:list' %}">{% trans 'Classifieds' %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans 'Write a new classified' %}</li>
    </ol>
  </nav>
  <form action="{% url 'classifieds:write_new' %}" enctype="multipart/form-data"  id="classified-form" method="post" role="form">
    {% csrf_token %}
    {{ form|crispy }}

    <div class="form-group">
      <button type="button" class="btn btn-dark publish">{% trans 'Publish' %}</button>
      <!--button type="button" class="btn btn-default draft">{% trans 'Save as draft' %}</button-->
      <a href="{% url 'classifieds:list' %}" class="btn btn-default">{% trans 'Cancel' %}</a>
    </div>
  </form>
  {{ form.media }}

<div id="cloudinary" > 
  <button id="upload_widget" class="cloudinary-button"> Upload image </button> <br> 
</div>

{% endblock content %}


{% block javascript %}
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script> 
<script type="text/javascript"> 
  const url = 'classifieds:write_new'
     
  var myWidget = cloudinary.applyUploadWidget(document.getElementById("upload_widget"), 
  {   cloudName: "obrisk",
      upload_preset: 'hizonedev_preset',
      //publicId: getFileName(),
      sources: "local,camera", 
      maxFiles: "6",  
      folder: "classifieds", 
      resourceType: "image",
      autoMinimize: "true",
  },
  (error, result) => { if (result.event == "success")  { 
    //All console.log are for debugging.
    console.log(result.info)
      // send a post request to one of your routes which would handle saving the data
      fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(result.info),
                })
                .then(response => response.json())

   } });

  document.getElementById("upload_widget").addEventListener("click", function(){
     myWidget.open();
  }, false);


</script>
<script src="{% static 'js/classifieds.js' %}"></script>

{% endblock %}

  
