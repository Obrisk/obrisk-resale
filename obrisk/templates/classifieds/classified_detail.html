{% extends 'base.html' %}
{% load static i18n %}
{% load crispy_forms_tags thumbnail humanize %}

{% block head %}
<link href="{% static 'css/classifieds.css' %} " rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/share.css' %}">
<link rel="stylesheet" href="{% static 'css/vendor/splide.min.css' %}">

<title>{{ classified.title|title }}</title>

{% endblock head %}

{# We need to check if the classified has images or else this will break #}
{% block icon %}
<link rel="icon" type="image/png" href="{{oss}}/{{ classified.thumbnail }}">
<link rel="shortcut icon" href="{{oss}}/{{ classified.thumbnail }}">
<link rel="apple-touch-icon" sizes="180x180"
  href="{{oss}}/{{ classified.thumbnail }}">
<link rel="icon" type="image/png" sizes="32x32"
  href="{{oss}}/{{  classified.thumbnail }}">
<link rel="icon" type="image/png" sizes="16x16"
  href="{{oss}}/{{ classified.thumbnail }}">
<link rel="mask-icon" href="{{oss}}/{{ classified.thumbnail }}" color="#5bbad5">
{% endblock %}

{% block meta %}
<meta name="author" content="{{ classified.user.get_profile_name }}">
<meta name="keywords" content="{{ classified.title }} ,{{ classified.english_address }}, {{ classified.city }}">
<meta name="description" content="{{ classified.details }}">
{% endblock %}


{% block content %}
<!-- Page Content -->
<div class="container view-wrapper">
   <section class="classified-wrapper">
        <div class="splide">
            <div class="splide__track">
                <ul class="splide__list">
                    {% for image in images %}
                      <div class="splide__slide">
                        <a href="{{oss}}/{{ image.image }}"
                          data-fslightbox="gallery">
                          <img class="classified-image" src="{{oss}}/{{ image.image_mid_size }}"/>
                        </a>
                     </div>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="classified-meta">
            <h3 class="cls-title title is-5">{{ classified.title|title }}</h3>
            <div class="meta-info">
              <a class="user-link" href="{% url 'users:detail' classified.user.username %}">
                {% if classified.user.thumbnail %}
                <img src="{{oss}}/{{classified.user.thumbnail}}"
                  alt="Picture Profile" id="pic">
                {% else %}
                <img src="{% static 'img/user.png' %}" height="35px" width="35px" alt="No Profile Picture" />
                {% endif %}
              </a>

              <div class="meta-right">
                  <div class="meta-right-top">
                    <a itemprop="author" itemscope="" itemtype="http://schema.org/Person"
                      href="{% url 'users:detail' classified.user.username %}">
                      <strong itemprop="name" id="classified-user">
                        {{ classified.user.get_profile_name|title }} </strong>
                    </a>

                    <!-- Price -->
                    {% if classified.price == 0.00 %}
                      <strong class="price"> {% trans 'FREE' %} </strong>
                    {% elif classified.price is None %}
                      <strong class="price">  {% trans 'BID PRICE' %} </strong>
                    {% else %}
                      <strong class="price"> ¬•{{ classified.price }} </strong>
                    {% endif %}
                  </div>

                  <span class="location">
                    {% if classified.english_address  %}
                       üìç{{ classified.english_address }}, {{ classified.city }}
                    {% else %}
                       üìç{{ classified.user.city }}
                    {% endif %}
                  </span>
              </div>
           </div>

          {% if classified.status == 'A' %}
            <div class="action-wrapper">

                {% if classified.user != request.user %}
                    <a class="button chat-button"
                       href="{% url 'messager:classified_chat' classified.user classified.id %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                          stroke="#363636" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                          class="feather feather-message-square">
                          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Chat
                     </a>

                    <button class="button pay-button" onclick="javascript:callpay();return false;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart">
                          <circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle>
                          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        Buy
                    </button>
                       
                {% else %}
                    <a class="button chat-button" href="{% url 'classifieds:delete_classified' classified.pk %}"
                      title="{% trans 'Edit this classified' %}">
                      <i class="fa fa-pencil-square-o" aria-hidden="true"></i> üóëÔ∏è{% trans 'Delete/Sold' %}</a>

                    <a class="button pay-button" href="{% url 'classifieds:edit_classified' classified.id %}"
                      title="{% trans 'Edit this classified' %}">
                      <i class="fa fa-pencil-square-o" aria-hidden="true"></i> {% trans 'Edit' %}</a>
                {% endif %}
              </div>
          {% else %}
              <div class="notification is-warning">
                This item is no longer available
              </div>

          {% endif %}

        <div class="card-text">{{ classified.details }}</div>


        <!-- Cloud Tag Widget -->
        {% if classified.tags.all %}
            <!-- Cloud Tag Widget -->
              <div class="card classified-tags">
                  <h5 class="card-heading has-text-weight-medium has-text-white	">{% trans 'Popular tags' %}</h5>

                    <div class="card-body">
                      <div class="previsions">
                          {% for tag in classified.tags.all %}
                              <a href="{% url 'classifieds:list_by_tag' tag.slug %}"><span class="tag is-white">{{ tag }}</span></a>
                          {% endfor %}
                      </div>
                    </div>
               </div>
        {% endif %}
        <br/>

        {% if classified.video %}
              <video id="classified-video" class="vd-container" height="400vh" preload="metadata" 
                  x5-video-player-type="h5-page" controls controlsList="nodownload"
                  crossorigin webkit-playsinline playsinline preload control
		  poster="{{oss}}/{{ classified.thumbnail }}" style="background-color: #000;" >
                  <source src="{{oss}}/{{classified.video}}#t=0.5" type="video/mp4">
                  Your browser doesn' t support HTML5 video tag. 
              </video>
	<br/> <br/><br/>
        {% endif %}

        <!-- Similar lassified -->
        {% if similar_classifieds %}
          <h5 class="title related-title">Related Classifieds</h5>
          <div class="related">
            <!-- Classified Entries Column -->
            {% for classified in similar_classifieds %}
                <div class="card classified-card">
                  <!--Display image-->
                  <a href="{% url 'classifieds:classified' classified.slug %}"
                    style="color:black; text-decoration:none; background-color:none">
                    <div class="card-img-top img-responsive">

                      {% if classified.thumbnail %}
                      <img class="card-img lazyload" src="{{oss}}/{{ classified.thumbnail }}"
                        width="154px" height="154px">
                      {% else %}
                      <img class="card-img lazyload" src="{% static 'img/nophoto.jpg' %}"
                        width="154px" height="154px">
                      {% endif %}
                    </div>

                    <div class="divider"></div>

                    <div class="card-body">
                      <h6 class="card-title"> {{ classified.title}} </h6>

                      {% if classified.price != 0.00 %}
                          <p class="card-subtitle"> ¬•{{ classified.price|title }} </p>
                      {% else %}
                          <p class="card-subtitle"> {% trans 'FREE' %} </p>
                      {% endif %}
                      <span class="card-text small "><small>üìç</small> {{ classified.city|safe }}</span>

                    </div>
                    {% if classified.priority > 0 %}
                    <div class="priority">
                      Featured
                    </div>
                    {% endif %}

                  </a>
                </div>

            {% endfor %}
        </div>

      </div>
      {% endif %}

    <div class="notification off-ac">
        <img src="{% static 'img/qrcode.jpg' %}"
           height="100px" width="100px" alt="Obrisk QRcode"/>
        <span> Long press the QR code & follow our platform </span>
    </div>


   </section>
</div>

{% endblock content %}

{% block extra_js %}

<script src="{% static 'js/vendor/splide.min.js' %}"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js" type="text/javascript"></script>
<script src="{% static 'js/share.js' %}" type="text/javascript"></script>
<script defer src="{% static 'js/vendor/fslightbox.min.js' %}"></script>
<script type="text/javascript">

  function shareMe(title, text) {
        navigator.share({
          title: title,
          text: text,
          url: location.href,
        });
  }

  function gotochat(url) {
      if (typeof currentUser === 'undefined') {
        setCookie(
            "active-chat",
            "chat/{{classified.user}}",
            120);
        location.href = "/ws/messages/";
      }else {
        setCookie("active-chat", url, 120);
        location.href = "/ws/messages/";
      }
  }

  function goToEdit () {
        window.location.href=editUrl;
  }

  function callpay() {
	  const sg = encodeURIComponent("{{classified.slug}}");
	  window.location.replace("{% url 'classifieds:create_order' %}?sg=" + sg);
  }

  document.addEventListener('DOMContentLoaded', function () {
      const image_count = {{ images| length}}

      new Splide('.splide', {
            type: 'loop'
      }).mount();

      function copyToClipboard(text, el) {
        var copyTest = document.queryCommandSupported('copy');
        var elOriginalText = el.attr('data-original-title');

        if (copyTest === true) {
          var copyTextArea = document.createElement("textarea");
          copyTextArea.value = text;
          document.body.appendChild(copyTextArea);
          copyTextArea.select();
          try {
            var successful = document.execCommand('copy');
            var msg = successful ? 'Copied!' : 'Whoops, not copied!';
            $.wnoty({
              type: "success",
              message: "Copied"
            })
          } catch (err) {
            console.log('Oops, unable to copy');
          }
          document.body.removeChild(copyTextArea);
          el.attr('data-original-title', elOriginalText);
        } else {
          // Fallback if browser doesn't support .execCommand('copy')
          window.prompt("Copy to clipboard: Ctrl+C or Command+C, Enter", text);
        }
      }

	  fetch('{% url 'wx_req_cred' %}', {
	      headers: {
		"X-Requested-With": "XMLHttpRequest"
	      },
	      credentials: 'same-origin',
	      redirect: 'follow'
	    }).then (resp => resp.json())
	      .then (strData => {
          try {
              let data = JSON.parse(strData);
              if (data.success === true) {
                wx.config({
                    debug: false, 
                    appId: data.id,
                    timestamp: data.timestamp,
                    nonceStr: data.noncestr,
                    signature: data.signature,
                    jsApiList: [
                       'updateAppMessageShareData',
                       'updateTimelineShareData',
                       'onMenuShareAppMessage',
                       'onMenuShareTimeline'
                    ] 
                });

              } else {
                  console.log('failure to init wx');
              }
          } catch {
		      console.log('failure to init wx');
          }
	    })

        wx.ready(function(){
          try {
              const descr = "{{ classified.details | truncatechars:80 }}".replace(/[^a-zA-Z0-9 ]/g, '');
              const title = "{{ classified.title | truncatechars:80 }}".replace(/[^a-zA-Z0-9 ]/g, '');
              wx.onMenuShareAppMessage({ 
                    title: title, 
                    desc: 'CNY {{classified.price}} ' + descr, 
                    link: location.href, 
                      imgUrl: '{{oss}}/{{ classified.thumbnail }}', 
                    trigger: function (res) {
                        console.log(JSON.stringify(res));
                    },
                    success: function (res) {
                        console.log(JSON.stringify(res));
                    },
                    fail: function (res) {
                        console.log(JSON.stringify(res));
                    }
                })

              wx.onMenuShareTimeline({ 
                    title: title, 
                    desc: 'CNY {{classified.price}} ' + descr, 
                    link: location.href, 
                    imgUrl: '{{oss}}/{{ classified.thumbnail }}', 
                    trigger: function (res) {
                        console.log(JSON.stringify(res));
                    },
                    success: function (res) {
                        console.log(JSON.stringify(res));
                    },
                    fail: function (res) {
                        console.log(JSON.stringify(res));
                    }
                })
            }catch (e) {
                console.log(e);
            }
      });

      wx.error(function(res){
        console.log(res);
      });

  });
</script>

{% endblock extra_js %}
