{% extends 'base.html' %}
{% load static i18n %}
{% load crispy_forms_tags thumbnail humanize %}

{% block head %}
<link href="{% static 'css/classifieds.css' %} " rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/share.css' %}">
<link rel="stylesheet" href="{% static 'css/vendor/slider-pro.min.css' %}">
<link rel="stylesheet" href="{% static 'css/vendor/fancybox.min.css' %}">

<title>{{ classified.title|title }}</title>

{% endblock head %}

{# We need to check if the classified has images or else this will break #}
{% block icon %}
<link rel="icon" type="image/png" href="{{oss}}/{{images.0.image_thumb }}">
<link rel="shortcut icon" href="{{oss}}/{{images.0.image_thumb }}">
<link rel="apple-touch-icon" sizes="180x180"
  href="{{oss}}/{{images.0.image_thumb }}">
<link rel="icon" type="image/png" sizes="32x32"
  href="{{oss}}/{{images.0.image_thumb }}">
<link rel="icon" type="image/png" sizes="16x16"
  href="{{oss}}/{{images.0.image_thumb }}">
<link rel="mask-icon" href="{{oss}}/{{images.0.image_thumb }}" color="#5bbad5">
{% endblock %}

{% block meta %}
<meta name="author" content="{{ classified.user.get_profile_name }}">
<meta name="keywords" content="{{ classified.title }} ,{{ classified.address }}, {{ classified.city }}">
<meta name="description" content="{{ classified.details }}">
{% endblock %}


{% block content %}
<!-- Page Content -->
<div class="container view-wrapper">
   <section class="classified-wrapper">

       <div class="slider-wrapper">
          <div class="slider-pro" id="image-slider">
            <div class="sp-slides">
              {% for image in images %}
              <div class="sp-slide">
                  <a href="{{oss}}/{{ image.image }}"
                  data-fancybox="classified-gallery">
                  <img class="sp-image" src=""
                    data-src="{{oss}}/{{ image.image_mid_size }}" />
                </a>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="classified-meta">
              <!-- Title -->
              <h3 class="cls-title title is-5">{{ classified.title|title }}</h3>

              <div class="price-time">
                  <!-- Price -->
                  <strong class="price"> ¬•{{ classified.price }} </strong>

                  <!-- Date/Time -->
                  <small class="time" > ‚è≤Ô∏è  {{ classified.timestamp|naturaltime }} </small> 
              </div>

              <div class="meta-details">

                <div class="meta-right">
                  <a class="user-link" href="{% url 'users:detail' classified.user.username %}">
                    {% if classified.user.thumbnail %}
                    <img src="{{oss}}/{{classified.user.thumbnail}}"
                      alt="Picture Profile" id="pic">
                    {% else %}
                    <img src="{% static 'img/user.png' %}" height="35px" width="35px" alt="No Profile Picture" />
                    {% endif %}
                  </a>

                  <div class="meta-left">
                    <a itemprop="author" itemscope="" itemtype="http://schema.org/Person"
                      href="{% url 'users:detail' classified.user.username %}">
                      <strong itemprop="name" id="classified-user">
                        {{ classified.user.get_profile_name|title }} </strong>
                    </a>

                    <div class="location">
                      <span class="card-subtitle">
                        {% if classified.address  %}
                           üìç{{ classified.address }}, {{ classified.city }}
                        {% else %}
                           üìç{{ classified.user.city }}
                        {% endif %} </span>
                    </div>
                  </div>
                </div>

            {% if classified.status == 'A' %}
            <div class="action-wrapper">

                  <a class="button share share-button" id= 'shareMessage'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="#363636" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                      class="feather feather-share-2">
                      <circle cx="18" cy="5" r="3"></circle>
                      <circle cx="6" cy="12" r="3"></circle>
                      <circle cx="18" cy="19" r="3"></circle>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                  </a>

                    {% if classified.user != request.user %}
                       <div class="button chat-button"
                        onclick="gotochat('{% url "messager:classified_chat" classified.user classified.id %}')"
                        ontouchstart="gotochat('{% url "messager:classified_chat" classified.user classified.id %}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                          stroke="#363636" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                          class="feather feather-message-square">
                          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Chat
                       </div>

                    {% else %}
                        <a class="button chat-button" href="{% url 'classifieds:edit_classified' classified.id %}"
                          title="{% trans 'Edit this classified' %}">
                          <i class="fa fa-pencil-square-o" aria-hidden="true"></i> {% trans 'Edit' %}</a>
                    {% endif %}
              </div>
          {% else %}
              <div class="notification is-warning">
                This item is no longer available
              </div>

          {% endif %}
          </div>

        <div class="card-text">{{ classified.details }}</div>

        <div class="seller-contacts-wrapper">
          {% if request.user.city == classified.city and classified.status == 'A' %}

            {% if classified.phone_number %}
                  <small class="seller-contacts"><strong>Seller's contacts:</strong>
                    <div class="btn-group">
                      <a class="button is-solid accent-button btn-email" href="tel:{{ classified.phone_number }}">üìû
                        CALL SELLER</a> </div>
                    <br />
                  </small>

            {%elif classified.wechat_id %}
                  <small class="seller-contacts w-75">
                    <strong>Seller's WechatID :</strong>
                    <div class="btn-group">
                      <a class="btn btn-primary btn-email btn-dark " href="#"><i class="fa fa-weixin"></i>
                        {{ classified.wechat_id }}</a>
                      <button type="button" class="button is-solid accent-button btn-copy js-tooltip js-copy" data-toggle="tooltip"
                        data-placement="bottom" data-copy="{{ classified.wechat_id }}" title=""
                        data-original-title="Copy to clipboard">
                        üìã
                      </button>
                    </div>
                  </small>
           {% endif %}

       {% elif user.is_authenticated %}
           
            <strong> This item is not available in your city or it is already bought </strong>

       {% else %}
            <h6> Please <a class="js-scroll-trigger login-text"
               href="{% url 'account_login' %}"> {% trans 'Login' %}</a>
               to view seller's contacts:
            </h6>
        {% endif %}

      </div>

          <!-- Cloud Tag Widget -->
          {% if classified.tags.all %}
                <!-- Cloud Tag Widget -->
                  <div class="card classified-tags">
                      <h5 class="card-heading has-text-weight-medium has-text-white	">{% trans 'Popular tags' %}</h5>

                        <div class="card-body">
                          <div class="previsions">
                              {% for tag in classified.tags.all %}
                                  <a href="{% url 'classifieds:list_by_tag' tag.slug %}"><span class="tag is-white">{{ tag }}</span></a>
                              {% endfor %}
                          </div>
                        </div>
                   </div>
          {% endif %}
        <br/>

        <!-- Similar lassified -->
        {% if similar_classifieds %}
          <h5 class="title related-title">Related Classifieds</h5>
          <div class="related">
            <!-- Classified Entries Column -->
            {% for classified in similar_classifieds %}
                <div class="card classified-card">
                  <!--Display image-->
                  <a href="{% url 'classifieds:classified' classified.slug %}"
                    style="color:black; text-decoration:none; background-color:none">
                    <div class="card-img-top img-responsive">

                      {% if classified.image_thumb %}
                      <img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.image_thumb }}"
                        width="154px" height="154px">
                      {% else %}
                      <img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/classifieds/default.jpg"
                        width="154px" height="154px">
                      {% endif %}
                    </div>

                    <div class="divider"></div>

                    <div class="card-body">
                      <h6 class="card-title"> {{ classified.title}} </h6>

                      {% if classified.price != 0.00 %}
                          <p class="card-subtitle"> ¬•{{ classified.price|title }} </p>
                      {% else %}
                          <p class="card-subtitle"> {% trans 'FREE' %} </p>
                      {% endif %}
                      <span class="card-text small "><small>üìç</small> {{ classified.city|safe }}</span>

                    </div>
                    {% if classified.priority > 0 %}
                    <div class="priority">
                      Featured
                    </div>
                    {% endif %}

                  </a>
                  <script type="application/ld+json">
                  {
                     "@context":"http://schema.org/",
                     "@type":"Product",
                     "name":"{{ classified.title}}",
                     "description":"Visit https://obrisk.com{% url 'classifieds:classified' classified.slug %} for more details",
                     "image":[
                        "https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.image_thumb }}"
                     ],
                     "brand":"",
                     "offers":{
                        "@type":"Offer",
                        "priceCurrency":"CNY",
                        "price":{{ classified.price|title }},
                        "availability":"http://schema.org/InStock",
                        "itemCondition":"http://schema.org/UsedCondition",
                        "url":"https://obrisk.com{% url 'classifieds:classified' classified.slug %}"
                     }
                  }
                  </script>

                </div>

            {% endfor %}
        </div>

      </div>
      {% endif %}

    <div class="notification off-ac">
        <img src="{% static 'img/qrcode.jpg' %}"
           height="100px" width="100px" alt="Obrisk QRcode"/>
        <span> Long press the QR code & follow our platform
            to explore more</span>
    </div>


   </section>
</div>

{% endblock content %}

{% block extra_js %}
<script type="application/ld+json">
{
   "@context":"http://schema.org/",
   "@type":"Product",
   "name":"{{ classified.title|title }}",
   "description":"{{ classified.details }}",
   "image":[
      "{{oss}}/{{images.0.image_thumb }}"
   ],
   "brand":"",
   "offers":{
      "@type":"Offer",
      "priceCurrency":"CNY",
      "price":{{ classified.price }},
      "availability":"http://schema.org/InStock",
      "itemCondition":"http://schema.org/UsedCondition",
      "url":"https://obrisk.com{% url 'classifieds:classified' classified.slug %}",
      "seller":{
         "@type":"Person",
         "name":"{{ classified.user.get_profile_name }}",
         {% if classified.user.thumbnail %}
         "image":"{{oss}}/{{classified.user.thumbnail}}"
         {% else %}
        "image":"{{oss}}/classifieds/default.jpg"
         {% endif %}

      }
   }
}
</script>

<script src="{% static 'js/vendor/jquery.min.js' %}" type="text/javascript"></script>
<script defer src="{% static 'js/vendor/fancybox.min.js' %}"></script>
<script defer src="{% static 'js/vendor/jquery.sliderPro.min.js' %}"></script>
<script defer src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js" type="text/javascript"></script>
<script type="text/javascript">

    fetch('{% url 'wx_req_cred' %}', {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      },
      credentials: 'same-origin',
      redirect: 'follow'
    }).then (resp => resp.json())
      .then (data => {
          if (data.info.success == true) {
            wx.config({
                debug: true, 
                appId: data.info.id,
                timestamp: data.info.timestamp,
                nonceStr: data.info.noncestr,
                signature: data.info.signature,
                jsApiList: [
                   'updateAppMessageShareData','updateTimelineShareData' 
                ] 
            });

            wx.ready(function(){
		    console.log('here')
		    document.getElementById('shareMessage').AddEventListener('click', () => {
		    console.log('clicked!');
                    wx.updateAppMessageShareData({ 
                        title: '{{ classified.title }}', 
		        desc: 'CNY {{classified.price}} {{ classified.details | truncatechars:20 }}', 
                        link: location.href, 
                        imgUrl: '{{oss}}/{{images.0.image_thumb }}', 
                        trigger: function (res) {
				console.log(JSON.stringify(res));
                        },
                        success: function (res) {
				console.log(JSON.stringify(res));
                        },
                        fail: function (res) {
				console.log(JSON.stringify(res));
                        }
                    })
                })

                function shareMeMoments(title, text) {
                    wx.updateTimelineShareData({ 
                        title: title, 
                        desc: 'Check out this item', 
                        link: location.href, 
                        imgUrl: '{{oss}}/{{images.0.image_thumb }}', 
                        success: function () {
                          // Indicates that the configuration is successful.
                        }
                    })
                }

            });
            wx.error(function(res){
		console.log(res);
            });

          } else {
              console.log('failure to init wx');
          }
    })

  function gotochat(url) {
      if (typeof currentUser === 'undefined') {
        setCookie(
            "active-chat",
            "chat/{{classified.user}}",
            120);
        location.href = "/ws/messages/";
      }else {
        setCookie("active-chat", url, 120);
        location.href = "/ws/messages/";
      }
  }

  function goToEdit () {
        window.location.href=editUrl;
  }

  document.addEventListener('DOMContentLoaded', function () {
      const image_count = {{ images| length}}

      if (image_count > 1) {
        $(".slider-pro").sliderPro({
          arrows: true,
          width: 960,
          fade: true,
          autoplay: false,
          autoScaleLayers: false,
          autoHeight: true,

        });
      } else {
        $(".slider-pro").sliderPro({
          arrows: true,
          width: 960,
          fade: true,
          autoplay: false,
          autoScaleLayers: false,
          autoHeight: true,
          touchSwipe: false,//disable touch swipe if we have only one image


        });
      }

      function copyToClipboard(text, el) {
        var copyTest = document.queryCommandSupported('copy');
        var elOriginalText = el.attr('data-original-title');

        if (copyTest === true) {
          var copyTextArea = document.createElement("textarea");
          copyTextArea.value = text;
          document.body.appendChild(copyTextArea);
          copyTextArea.select();
          try {
            var successful = document.execCommand('copy');
            var msg = successful ? 'Copied!' : 'Whoops, not copied!';
            $.wnoty({
              type: "success",
              message: "Copied"
            })
          } catch (err) {
            console.log('Oops, unable to copy');
          }
          document.body.removeChild(copyTextArea);
          el.attr('data-original-title', elOriginalText);
        } else {
          // Fallback if browser doesn't support .execCommand('copy')
          window.prompt("Copy to clipboard: Ctrl+C or Command+C, Enter", text);
        }
      }
  });
</script>

{% endblock extra_js %}
