{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ classified.title }}{% endblock %}

{% block head %}
<link href="{% static 'css/user_profile.css' %}" rel="stylesheet">

<script src="{% static 'js/vendor/vconsole.min.js' %}"></script>
<script>
var vConsole = new VConsole();
</script>
{% endblock head %}

{% block content %}

<div>
  <div class="media profile profile-header m-2">
      {% if classified.image_thumb %}
          <img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.thumbnail }}"
            width="154px" height="154px">
      {% else %}
          <img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/classifieds/default.jpg"
            width="154px" height="154px">
      {% endif %}

    <h6 class="media-body mt-0">{{ classified.title }}</h6>

  <p class="media-body mt-0"> Price: {{ classified.price }} CNY</p>
  <div class="is-flex">
    <a class="button accent-button mb-2" href="javascript:history.back()">{% trans 'Cancel' %}</a>
    <button class="button accent-button m-2 p-2" onclick="javascript:initPay();return false;">{% trans 'Pay' %}</button>
  </div>

</div>

</div>
{% endblock content %}

{% block extra_js %}

<script defer src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js" type="text/javascript"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {

  fetch('{% url 'wx_req_cred' %}', {
      headers: {
    "X-Requested-With": "XMLHttpRequest"
      },
      credentials: 'same-origin',
      redirect: 'follow'
    }).then (resp => resp.json())
      .then (strData => {
      try {
          let data = JSON.parse(strData);
          if (data.success === true) {
            wx.config({
                debug: true, 
                appId: data.id,
                timestamp: data.timestamp,
                nonceStr: data.noncestr,
                signature: data.signature,
                jsApiList: [
                   'chooseWXPay'
                ] 
            });

          } else {
              console.log('failure to init wx');
          }
      } catch {
          console.log('failure to init wx');
      }
    })

    wx.ready(function(){
        function initPay() {
              try {
                  if ("{{data.timeStamp}}" === undefined) {
                       console.log('failed to initialize wechat pay')
                    }else {
                        wx.chooseWXPay({
                            timestamp: "{{data.timeStamp}}", 
                            nonceStr: "{{data.nonceStr}}",
                            package: "{{data.package}}", 
                            signType: "{{data.signType}}",
                            paySign: "{{data.sign}}"
                            trigger: function (res) {
                                console.log(JSON.stringify(res));
                            },
                            success: function (res) {
                                console.log(JSON.stringify(res));
                            },
                            fail: function (res) {
                                console.log(JSON.stringify(res));
                            }
                        });
                    }

              } catch {
                  console.log('failure to init payments');
              }
        }
    });

    wx.error(function(res){
        console.log(res);
    });

});
</script>

{% endblock extra_js %}
