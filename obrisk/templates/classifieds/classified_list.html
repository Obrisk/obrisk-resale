{% extends 'base.html' %}
{% load static i18n %}
{% load humanize thumbnail %}
{% block title %} {% trans 'Classifieds' %} {% endblock %}

{% block head %}
<link href="{% static 'css/listing.css' %}" rel="stylesheet">
<link href="{% static 'css/classifieds.css' %}" rel="stylesheet">
<link href="{% static 'css/classifieds-list.css' %}" rel="stylesheet">
<title>Obrisk Classifieds </title>
{% endblock head %}

{% block content %}
<div class="app-overlay"></div>

<div class="view-wrapper">
  <!-- Container -->
  <div id="main-feed" class="container">
    <div id="" class="view-wrap true-dom">
      <div class="columns">

        <div class="tags-card-wrapper">

          <!-- Cloud Tag Widget -->
          <div class="card is-weather-card">
            <div class="card-heading">
              <h5 class="has-text-weight-medium	 has-text-white	">{% trans 'Popular tags' %}</h5>

            </div>
            <div class="card-body">

              <div class="previsions">
                {% for tag, count in popular_tags %}
                <a href="{% url 'classifieds:list_by_tag' tag %}"><span class="tag is-white">{{ count }}
                    {{ tag }}</span></a>
                {% endfor %}

              </div>

            </div>
          </div>
        </div>
        <!-- /Left side column -->

        <div class="column is-9-fullhd classifieds-list-wrapper">

          <div id="classifieds" class="small-cards-listing">
             {% for classified in classifieds %}
                <!-- Classified ad. -->
                <div class="card classified-card">
                  <!--Display image-->

                  <a href="{% url 'classifieds:classified' classified.slug %}"
                    style="color:black; text-decoration:none; background-color:none">
                    <div class="card-img-top img-responsive">

                      {% if classified.image_thumb %}
                      <img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.image_thumb }}"
                        width="154px" height="154px">
                      {% else %}
                      <img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/classifieds/default.jpg"
                        width="154px" height="154px">
                      {% endif %}
                    </div>

                    <div class="divider"></div>

                    <div class="card-body">
                      <h6 class="card-title"> {{ classified.title}} </h6>

                      {% if classified.price != 0.00 %}
                          <p class="card-subtitle O-cl-red"> ¬•{{ classified.price|title }} </p>
                      {% else %}
                          <p class="card-subtitle O-cl-red"> {% trans 'FREE' %} </p>
                      {% endif %}
                      <div class="card-meta">

                        <span class="card-text small "><small>üìç</small> {{ classified.city|safe }}</span>

                      </div>
                      <!-- <div class="card-meta d-flex justify-content-between mt-2">

                        <div class="chat-button">
                          <small class="button p-1 share"
                            onclick="gotochat('{% url "messager:classified_chat" classified.user classified.id %}')"
                            ontouchstart="gotochat('{% url "messager:classified_chat" classified.user classified.id %}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                              stroke="#3EC4E2" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                              class="feather feather-message-square">
                              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></svg>
                            Chat</small>

                        </div>
                        <div class="share-button">
                          <small class="button p-1 share"
                            onclick="shareMe('Bing is blocked in China','Hangzhou 0.00 ','/classifieds/boni-bing-is-blocked-in-china-2019-12-09-1/')"
                            ontouchstart="shareMe('Bing is blocked in China','Hangzhou 0.00 ','/classifieds/boni-bing-is-blocked-in-china-2019-12-09-1/')"><svg
                              xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3EC4E2"
                              stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2">
                              <circle cx="18" cy="5" r="3"></circle>
                              <circle cx="6" cy="12" r="3"></circle>
                              <circle cx="18" cy="19" r="3"></circle>
                              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg> Share</small>
                        </div>
                      </div> -->

                    </div>
                    {% if classified.priority > 0 %}
                    <div class="priority">
                      Featured
                    </div>
                    {% endif %}

                  </a>
                  <script type="application/ld+json">
                  {
                     "@context":"http://schema.org/",
                     "@type":"Product",
                     "name":"{{ classified.title}}",
                     "description":"Visit https://obrisk.com{% url 'classifieds:classified' classified.slug %} for more details",
                     "image":[
                        "https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{ classified.image_thumb }}"
                     ],
                     "brand":"",
                     "offers":{
                        "@type":"Offer",
                        "priceCurrency":"CNY",
                        "price":{{ classified.price|title }},
                        "availability":"http://schema.org/InStock",
                        "itemCondition":"http://schema.org/UsedCondition",
                        "url":"https://obrisk.com{% url 'classifieds:classified' classified.slug %}"
                     }
                  }
                  </script>

                </div>

            {% empty %}
                <small class="empty-ad">{% trans 'üòÉ Welcome' %} {{ request.user.username }}.
                  {% trans 'It looks like there are no items near you.' %}
                  <a href="{% url 'classifieds:write_new' %}"> {% trans ' Be the first to post' %}</a>
                </small>
                <br />
            {% endfor %}

          </div>
          <div class="loading classified-card is-hidden">
            <div class="stage">
              <div class="dot-pulse"></div>
            </div>
          </div>

      </div>
      <!-- /Middle column -->

    </div>
  </div>
</div>


{% endblock content %}

{% block extra_js %}

<script type="text/javascript">

  const oss_url = "{% url 'get_oss_auth' %}"; //classifieds/get_oss_auth/
  const user = "{{ request.user.username }}";
  const app = "classifieds";

  const title_id = "{{ form.title.auto_id }}";
  const details_id = "{{ form.details.auto_id }}";
  const address = "{{ form.address.auto_id }}";
  //const tags = "{{ form.tags.auto_id }}";
</script>


<script>
  var page = 1;
  var empty_page = false;
  var block_request = false;
  var is_tag_page = "{{tag}}";
  var lastScrollTop = 0;

  if (is_tag_page == "None") {
    window.addEventListener('scroll', function () {
      if (empty_page == false && block_request == false) {
        block_request = true;
        page += 1;
        document.querySelector('.loading').classList.remove('is-hidden')

        fetch(`/classifieds/?page=${page}`,
        {
          headers: {
            "X-Requested-With": "XMLHttpRequest"
          }
        }).then (resp => resp.json())
        .then (data => {

          if (data == "") {
            empty_page = true;
            document.querySelector('.loading').classList.add('is-hidden');
            document.querySelector('.classifieds-container').append('<div class="end-classifieds"> End of Classifieds</div>');
          } else {
            document.querySelector('.loading').classList.add('is-hidden');
            block_request = false;

              for (const cls of data.classifieds) {

                  if ( cls.image_thumb != "" ) {
                    const img = `<img class="card-img lazyload" src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/${cls.image_thumb}" width="154px" height="154px">`;
                  }else {
                    const img = "<img class='card-img lazyload' src='https://obrisk.oss-cn-hangzhou.aliyuncs.com/classifieds/default.jpg' width='154px' height='154px'>";
                  }

                  if (cls.price != 0.00){
                      const price = `<p class="card-subtitle O-cl-red"> ¬•${cls.price} </p>`;
                  } else {
                      const price = "<p class='card-subtitle O-cl-red'> FREE </p>";
                  }
                  const url = window.location.hostname + cls.slug;

                  template = `
                    <div class="card classified-card">
                      <a href="${url}"
                        style="color:black; text-decoration:none; background-color:none">

                        <div class="card-img-top img-responsive">
                            ${img}
                        </div>
                        <div class="divider"></div>
                        <div class="card-body">
                          <h6 class="card-title"> ${cls.title} </h6>
                           ${price}
                          <div class="card-meta">

                            <span class="card-text small "><small>üìç</small> ${ cls.city}</span>

                          </div>
                        </div>
                      </a>
                    </div>
                        `;
                  document.querySelector('#classifieds').append(template);
              }
            }
        }).catch (err => {
            console.log(err);
        });
      }
    });
  }

function goToEdit () {
    window.location.href=editUrl;
}

function shareMe(title, text) {
    navigator.share({
      title: title,
      text: text,
      url: location.href,
    });
}
</script>
{% endblock extra_js %}
