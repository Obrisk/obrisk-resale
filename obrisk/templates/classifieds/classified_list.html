{% extends 'base.html' %}
{% load static i18n %}
{% load humanize thumbnail %}
{% block title %} {% trans 'Classifieds' %} {% endblock %}

{% block head %}
<link href="{% static 'css/listing.css' %}" rel="stylesheet">
<link href="{% static 'css/classifieds.css' %}" rel="stylesheet">
<link href="{% static 'css/classifieds-list.css' %}" rel="stylesheet">
<title>Obrisk Classifieds </title>
{% endblock head %}

{% block content %}
<div class="app-overlay"></div>

<div class="view-wrapper">
  <!-- Container -->
  <div id="main-feed" class="container">
    <div id="" class="view-wrap true-dom">
      <div class="columns">

        <!-- Left side column -->
        <!-- For small devices the tags is disabled because of a bug, when fixed also update listing.js(23)-->
        <div class="column is-3 is-hidden-mobile is-hidden-tablet-only is-hidden-desktop-only"
          style="height: 500px;position: sticky;top: 0px;">
          <!-- Sidebar Widgets Column -->

          <div class="position-fixed">
            <!-- Write Classified Widget -->
          <div class="d-flex mb-3">
            <a class="button is-solid accent-button raised align-self-center" id="addNewClassified" href="#"
              title="Write a new classified"><i class=" mr-2" data-feather="plus-circle"></i>
              {% trans 'Add new item' %}
            </a>

            </div>

          <!-- Cloud Tag Widget -->
          <div class="card is-weather-card" style="width: 300px;">
            <div class="card-heading">
              <h5 class="has-text-weight-medium	 has-text-white	">{% trans 'Popular tags' %}</h5>

            </div>
            <div class="card-body">


              <div class="previsions d-block">
                {% for tag, count in popular_tags %}
                <a href="{% url 'classifieds:list_by_tag' tag %}"><span class="tag is-white">{{ count }}
                    {{ tag }}</span></a>
                {% endfor %}

              </div>

            </div>
          </div>
        </div>
      </div>
        <!-- /Left side column -->

        <!-- Middle column -->
        <div class="column is-9-fullhd">
          <div class="col-md-8 m-auto mt-0 p-sm-0">
            <div id="compose-card" class="card is-new-content is-hidden p-2">
              <!-- Top tabs -->
              <div class="tabs-wrapper">
                <div class="tabs is-boxed is-fullwidth">
                  <ul>
                    <li class="is-active">
                      <a>
                        <i data-feather="edit-3"></i>
                        <span>
                            {% trans 'Publish' %}
                        </span>
                      </a>
                    </li>
                    <!-- Close X button -->
                    <li class="close-wrap is-hidden">
                      <span class="close-publish">
                        <i data-feather="x"></i>
                      </span>
                    </li>
                  </ul>
                </div>

                <!-- Tab content -->
                <div class="alert alert-error is-hidden">
                  <strong><span id="data-errors"> </span></strong>
                </div>

                <form action="{% url 'classifieds:write_new' %}" name="classifiedForm" enctype="multipart/form-data"
                  id="classified-form" method="post" role="form">
                  {% csrf_token %}

                  <div class="column">
                    <div class="form-panel">
                      <div class="field">
                        <label>
                            {% trans 'Title*' %}
                        </label>
                        <div class="control">
                          <input type="text" id="id_title" name="title" maxlength="80" class="input" required
                            placeholder="Enter your item title">
                        </div>
                      </div>
                      <div class="field">
                        <label>
                            {% trans 'Details*' %}
                        </label>
                        <div class="control">
                          <textarea name="details" id="id_details" cols="40" rows="3" maxlength="2000" required
                            class="textarea"
                            placeholder="Provide enough details, to make it easier for buyers to understand your item!">
                          </textarea>
                        </div>
                      </div>
                      <div class="field d-flex justify-content-between">
                        <div class="">
                          <label>
                              {% trans 'Price*' %}
                          </label>
                          <small class="form-text text-muted" id="hint_id_price">
                             {% trans '0 for GIVEAWAY' %} </small>
                        </div>
                        <div class="control">
                         RMB <input type="number" id="id_price" name="price" class="numberinput input w-100" id="id_price"
                            required step="1.00" value="0" placeholder="Item price">
                        </div>
                      </div>

                      <div class="hidden-fields">
                        <input type="hidden" id="id_images" name="images" maxlength="3000" class="input" required>
                        <input type="hidden" id="id_img_errors" name="img_errors" maxlength="2000" class="input">
                        <input type="hidden" id="id_edited" name="edited" class="input">
                        <input type="hidden" id="id_status" name="status" maxlength="20" class="input">
                      </div>

                      {% if request.user.phone_number.national_number != 13300000000 and request.user.phone_number.national_number >= 1 %}
                      <div class="field is-flex justify-content-between">
                        <label>
                            {% trans 'Include your phone no? ' %}
                        </label>
                        <label class="f-switch is-accent">
                          <input type="checkbox" checked class="is-switch" name="show_phone" id="id_show_phone">
                          <i></i>
                        </label>
                      </div>

                      {% else %}
                      <div class="field">
                        <label for="id_phone_number" class="">
                            {% trans 'Phone number(optional)' %}
                        </label>
                        <input type="tel" name="phone_number" placeholder="Don't enter country code" class="input"
                          id="id_phone_number">
                      </div>
                      {% endif %}
                    </div>
                    <div class="field">

                      <label>
                          {% trans 'Images*' %}
                      </label>
                      <div class="control">
                        <div id="wrapper" class="mb-4">
                          <div id="container">
                            <div id="uploader">
                              <div class="queueList">
                                <ul class="filelist"></ul>
                              </div>
                            </div>
                            <div id="statusBar" class="statusBar  flex-column align-items-center" style="display:none">
                              <div class="total-progress">
                                <div id="totalProgressBar" class="total-progress-bar" role="progressbar"
                                  aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                </div>
                              </div>
                              <div class="upload-btn d-flex flex-column flex-md-row">
                                <div class="start-uploader startUploadBtn ml-2 mr-2">
                                  <a id="startUpload" href="javascript:void(0);" class="text">
                                      {% trans 'Upload images' %}
                                  </a>
                                </div>
                                <div class="start-uploader addBtn ml-2 mr-2">
                                  <a id="addBtn" href="javascript:void(0);" class="text button">
                                      {% trans 'Add images' %}
                                  </a>
                                </div>
                              </div>
                            </div>
                            <div class="m-auto justify-content-center d-flex ">
                              <div id="uploaderPick">
                                <a id="chooseFile" href="javascript:void(0);" class="text m-auto button">
                                    {% trans 'Add images' %}
                                </a>
                              </div>
                            </div>
                            <div class="" style="clear: both;">
                              <p class="text-center">
                              {% trans 'Notes:' %}
                              {% trans 'Can select up to 8 multiple images & Max size per image is 13MB' %}
                              </p>
                            </div>
                          </div>
                        </div>

                        <div class="container bs-docs-container">
                          <form id="form">
                            <input id="image-file" type="file" style="display:none;" multiple="multiple"
                              accept="image/*" />
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>


                <div class="buttons">
                  {% if request.user.is_authenticated %}
                      <button id="create-btn" type="button"
                        class="button is-solid accent-button raised create submit-button">{% trans 'Submit' %}</button>
                  {% else %}
                      <button id="create-btn" type="button" onclick="window.location.href='/auth/login/'"
                        class="button is-solid accent-button raised">
                          {% trans 'Login & Post ' %}
                     </button>
                  {% endif %}

                  <button type="button"
                    class="ml-4 button is-solid dark-grey-button raised">
                        <span class="close-wrap">
                            <span class="close-publish"> {% trans 'Cancel' %} </span> </span>
                  </button>

                </div>

                </form>

                {{ form.media }}

              </div>
            </div>
          </div>

          <div id="classifieds" class="p-0 row justify-content-center justify-content-lg-start">
            {% include "classifieds/classified_list_ajax.html" %}

          </div>
          <div class="loading classified-card m-auto is-hidden">
            <div class="stage">
              <div class="dot-pulse"></div>
            </div>
          </div>


        </div>

      </div>
      <!-- /Middle column -->

      <!-- official ads for pc sized-->
      {% if official_ads %}
      <div class="right-sidebar is-hidden d-lg-block">
        {% include 'classifieds/ads.html' %}
      </div>
      {% endif %}

    </div>
  </div>
</div>


{% endblock content %}

{% block extra_js %}

<script type="text/javascript">

  const oss_url = "{% url 'get_oss_auth' %}"; //classifieds/get_oss_auth/
  const user = "{{ request.user.username }}";
  const app = "classifieds";

  const title_id = "{{ form.title.auto_id }}";
  const details_id = "{{ form.details.auto_id }}";
  const address = "{{ form.address.auto_id }}";
  //const tags = "{{ form.tags.auto_id }}";
</script>

<script src="{% static 'js/classifieds.js' %}" type="text/javascript"></script>
<script src="{% static 'js/listing.js' %}" type="text/javascript"></script>

<script>
  var page = 1;
  var empty_page = false;
  var block_request = false;
  var is_tag_page = "{{tag}}";
  if (is_tag_page == "None") {
    $(window).scroll(function () {
      if (empty_page == false && block_request == false) {
        block_request = true;
        page += 1;
        $('.loading').removeClass('is-hidden')
        $.get('?page=' + page, function (data) {
          if (data == '') {
            empty_page = true;
            $('.loading').addClass('is-hidden')
            $('.classifieds-container').append('<div class="m-auto"> End of Classifieds</div>')
          } else {
            $('.loading').addClass('is-hidden');
            block_request = false;
            $('#classifieds').append(data);
          }
        });
      }
    });
  }
</script>

<script>
</script>
{% endblock extra_js %}
