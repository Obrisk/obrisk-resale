{% extends 'base.html' %}
{% load static i18n %}
{% load humanize thumbnail %}
{% block title %} {% trans 'Classifieds' %} {% endblock %}

{% block head %}
<link href="{% static 'css/listing.css' %}" rel="stylesheet">
<link href="{% static 'css/classifieds.css' %}" rel="stylesheet">
<link href="{% static 'css/classifieds-list.css' %}" rel="stylesheet">
<title>Obrisk Classifieds </title>
{% endblock head %}

{% block content %}
<div class="app-overlay"></div>

<div class="view-wrapper">
  <!-- Container -->
  <div id="main-feed" class="container">
    <div id="" class="view-wrap true-dom">
      <div class="columns">

        <div class="tags-card-wrapper">

          <!-- Cloud Tag Widget -->
          <div class="card is-weather-card">
            <div class="card-heading">
              <h5 class="has-text-weight-medium	 has-text-white	">{% trans 'Popular tags' %}</h5>

            </div>
            <div class="card-body">

              <div class="previsions">
                {% for tag, count in popular_tags %}
                <a href="{% url 'classifieds:list_by_tag' tag %}"><span class="tag is-white">{{ count }}
                    {{ tag }}</span></a>
                {% endfor %}

              </div>

            </div>
          </div>
        </div>
        <!-- /Left side column -->

        <div class="column is-9-fullhd classifieds-list-wrapper">

          <div id="classifieds" class="small-cards-listing">
            {% include "classifieds/classified_list_ajax.html" %}

          </div>
          <div class="loading classified-card is-hidden">
            <div class="stage">
              <div class="dot-pulse"></div>
            </div>
          </div>

      </div>
      <!-- /Middle column -->

    </div>
  </div>
</div>


{% endblock content %}

{% block extra_js %}

<script type="text/javascript">

  const oss_url = "{% url 'get_oss_auth' %}"; //classifieds/get_oss_auth/
  const user = "{{ request.user.username }}";
  const app = "classifieds";

  const title_id = "{{ form.title.auto_id }}";
  const details_id = "{{ form.details.auto_id }}";
  const address = "{{ form.address.auto_id }}";
  //const tags = "{{ form.tags.auto_id }}";
</script>


<script>
  var page = 1;
  var empty_page = false;
  var block_request = false;
  var is_tag_page = "{{tag}}";
  var lastScrollTop = 0;

  if (is_tag_page == "None") {
    window.addEventListener('scroll', function () {
      if (empty_page == false && block_request == false) {
        block_request = true;
        page += 1;
        document.querySelector('.loading').classList.remove('is-hidden')

        fetch(`/classifieds/?page=${page}`)
        .then (resp => resp.text())
        .then (data => {

          if (data == '') {
            empty_page = true;
            document.querySelector('.loading').classList.add('is-hidden');
            document.querySelector('.classifieds-container').append('<div class="end-classifieds"> End of Classifieds</div>');
          } else {
            console.log(data);
            document.querySelector('.loading').classList.add('is-hidden');
            block_request = false;

            // Convert the HTML string into a document object
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');
            document.querySelector('#classifieds').append(doc);
          }
        });
      }
    });
  }

function goToEdit () {
    window.location.href=editUrl;
}

function shareMe(title, text) {
    navigator.share({
      title: title,
      text: text,
      url: location.href,
    });
}
</script>
{% endblock extra_js %}
