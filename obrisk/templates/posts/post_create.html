{% extends 'base.html' %}
{% load static i18n %}
{% load crispy_forms_tags %}

{% block head %}
<link href="{% static 'css/post-create.css' %}" rel="stylesheet">
<link rel="stylesheet" href="/static/css/uploader.css" />
<link rel="stylesheet" href="/static/css/classified-create.css" />

<script src="{% static 'js/aliyun-oss.min.js' %}" type="text/javascript"></script>
<title>Obrisk Create Post</title>

{% endblock head %}

{% block content %}
<div class="col-lg-8 ml-auto mr-auto mt-5 pt-4 pb-4 mb-5">
  {{form.errors}}
  <form action="{% url 'posts:write_new' %}" enctype="multipart/form-data" id="posts-form" method="post" role="form">
    {% csrf_token %}
    {{ form|crispy }}
    <button type="button" id="add-cover-image" class="btn btn-dark"
      onclick="document.getElementById('cover-image').click();">{% trans 'Upload Cover Image' %}</button>
    <div class="form-group">

      <input class="d-none" name="coverimage" id="cover-image" type="file" onchange="uploadPreview(this)">
      <img src="#" alt="cover image" id="cover" class="img-fluid d-none mt-2" style="max-width: 300px;max-height:100%;">
    </div>
    <div class="form-group">
      <button type="button" id="post-submit" class="btn btn-dark publish">{% trans 'Publish' %}</button>
      <button type="button" id="post-draft" class="btn btn-default draft">{% trans 'Save as draft' %}</button>
      <a href="{% url 'posts:list' %}" class="btn btn-default">{% trans 'Cancel' %}</a>
    </div>
  </form>


  {{ form.media }}

</div>

{% endblock content %}

{% block extra_js %}
<script type="text/javascript">

  const oss_url = "{% url 'get_oss_auth' %}"; //classifieds/get_oss_auth/
  const user = "{{ request.user.username }}";

  const app = "articles";

  const title_id = "{{ form.title.auto_id }}";

</script>

<script src="{% static 'js/aliyun-oss.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/classifieds.js' %}" type="text/javascript"></script>
<script src="{% static 'js/posts.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/quill-emoji.css' %}">
<script src="{% static 'js/quill-emoji.js' %}"></script>
<script src="{% static 'js/quill-magic-url.js' %}"></script>
<script src="{% static 'js/quill-blot-formatter.min.js' %}"></script>





<script>
  $(document).ready(function () {
    var toolbarOptions = {
      container: [
        [{
          'header': [1, 2, 3, 4, 5, 6, false]
        }],
        ['bold', 'italic', 'underline', 'strike'], // toggled buttons
        ['blockquote', 'code-block'],

        [{
          'header': 1
        }, {
          'header': 2
        }], // custom button values
        [{
          'list': 'ordered'
        }, {
          'list': 'bullet'
        }],

        [{
          'indent': '-1'
        }, {
          'indent': '+1'
        }], // outdent/indent
        [{
          'color': []
        }, {
          'background': []
        }], // dropdown with defaults from theme

        [{
          'align': []
        }],
        ['link', 'image'],


        ['clean'] // remove formatting button

      ], handlers: {
        'emoji': function () { }
      }
    }
    Quill.register('modules/blotFormatter', QuillBlotFormatter.default);
    if ($("#editor-container").length) {
      const quill = new Quill('#editor-container', {
        modules: {
          toolbar: toolbarOptions,
          "emoji-toolbar": true,
          "emoji-shortname": true,
          "emoji-textarea": true,
          magicUrl: true,
          blotFormatter: {}
        },
        placeholder: 'Compose an epic...',
        theme: 'snow',

      });
    } else {
      const quill = new Quill('.markdownx', {
        modules: {
          toolbar: toolbarOptions,
          "emoji-toolbar": true,
          "emoji-shortname": true,
          "emoji-textarea": true,
          magicUrl: true,
          blotFormatter: {}
        },
        placeholder: 'Compose an epic...',
        theme: 'snow',

      });
    }

    quill.setContents("{{ form.data.content_json }}")
    quill.on('text-change', function (delta, oldDelta, source) {
      $("#id_content").val(quill.getContents());
    });
    $("#posts-form").submit(function (e) {
      e.preventDefault();
      $("[name=content_html]").val(quill.root.innerHTML);
      $("[name=content_json]").val(JSON.stringify(quill.getContents()))
      $(this).unbind('submit').submit();
    });

  });
</script>
{% endblock extra_js %}