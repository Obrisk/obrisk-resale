{% extends 'base.html' %}
{% load static i18n %}
{% load crispy_forms_tags humanize %}

{% block head %}
<link href="{% static 'css/notifications.css' %}" rel="stylesheet">
<link href="{% static 'css/post-details.css' %}" rel="stylesheet">
<title>{{ post.title|title }}</title>
{% endblock head %}

{% block meta %}
<meta name="author" content="{{  post.user.get_profile_name }}">
<meta name="keywords" content="{{ post.title|title }} ">
{% endblock %}

{% block content %}
<!-- Page Content -->
<div class="container pt-4 pb-4 mb-5">
  <div class="stories-wrapper">
    <!-- Posts -->
    <div class="inner-wrapper">
      <!-- Post -->
      <div class="story-post-wrapper">
        <div class="story-post">
          <div class="post-title">
            <h2>{{ post.title|title }}</h2>
            <!--Dropdown-->
            <div class="dropdown is-spaced is-right is-accent dropdown-trigger">

              <!-- <div class="dropdown-menu" role="menu">
                <div class="dropdown-content">
                  <a href="#" class="dropdown-item">
                    <div class="media">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-wind">
                        <path
                          d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2">
                        </path>
                      </svg>
                      <div class="media-content">
                        <h3>Today</h3>
                        <small>View today's posts.</small>
                      </div>
                    </div>
                  </a>
                  <a class="dropdown-item">
                    <div class="media">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-calendar">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <div class="media-content">
                        <h3>This Week</h3>
                        <small>View this week's posts.</small>
                      </div>
                    </div>
                  </a>
                  <a class="dropdown-item">
                    <div class="media">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-archive">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                        <line x1="10" y1="12" x2="14" y2="12"></line>
                      </svg>
                      <div class="media-content">
                        <h3>This Month</h3>
                        <small>View this month's posts.</small>
                      </div>
                    </div>
                  </a>
                  <hr class="dropdown-divider">
                  <a href="#" class="dropdown-item">
                    <div class="media">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-users">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                      </svg>
                      <div class="media-content">
                        <h3>Close Friends</h3>
                        <small>Restrict to close friends.</small>
                      </div>
                    </div>
                  </a>
                  <a href="#" class="dropdown-item">
                    <div class="media">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-heart">
                        <path
                          d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                        </path>
                      </svg>
                      <div class="media-content">
                        <h3>Popular</h3>
                        <small>Show popular posts.</small>
                      </div>
                    </div>
                  </a>
                </div>
              </div> -->

            </div>
          </div>
          <div class="post-image-wrap">
            <!-- Featured Image -->
            {% if post.image %}
            <div class="card-img-top post-image"
                 style="background: url({{oss}}/{{post.image}}); padding-top:42%; background-size: cover;">
            </div>
            {% endif %}
          </div>
          <div class="post-meta">
            <div class="post-author">
              <div class="story-avatar">
                {% if post.user.thumbnail %}

                <img class="avatar img-fluid" src="{{oss}}/{{post.user.thumbnail}}"
                  style="width:100%;height:100%;border-radius: 50%;" alt="">
                {% else %}
                <img class="avatar img-fluid" style="width:100%;height:100%;" src="{% static 'img/user.png' %}"
                  alt="No Profile Picture" />
                {% endif %}

              </div>
              <div class="meta">
                <span>{{ post.user.get_profile_name|title }}</span>
                <span>{{ post.timestamp|naturaltime }}</span>

              </div>
            </div>
          </div>

          <div class="post-text content">
            {% if post.content_html %}
                {{ post.content_html|safe}}
            {%else %}
                <!-- support lagacy posts -->
                {{ post.get_markdown|safe }}
            {%endif%}

          </div>

           <div class="buttons" >     
               <div class="share-button pr-2">
                  <div class="button share w-100"
                    onclick="shareMe('{{ post.title }}','{{ post.author }}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="#3EC4E2" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                      class="feather feather-share-2">
                      <circle cx="18" cy="5" r="3"></circle>
                      <circle cx="6" cy="12" r="3"></circle>
                      <circle cx="18" cy="19" r="3"></circle>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg> Share
                  </div>
                </div>

              {% if request.user == post.user %}
                <button type="button" onclick="goToEdit();"
                    class="button is-solid accent-button raised"> 
                      {% trans 'Edit ' %}
                 </button>
              {% endif %}
          </div> 
          
          </div> 

            <!-- Cloud Tag Widget -->
            <div class="card">
              <h5 class="card-header text-dark" style="background-color: #3EC4E2;">{% trans 'Tags' %}</h5>
              <div class="card-body">
                {% for tag in post.tags.all %}
                <a href="#"><span class="badge badge-info">{{ tag }}</span></a>
                {% endfor %}
              </div>
            </div>

          <div class="post-compose">
            {% if new_comment %}
                <h2>Your comment has been added.</h2>
            {% else %}

            <div id="comment-notify"> </div>

            <div class="card">
              <div class="card-body">
                <h3>Leave a Comment: </h3>
                <form method="post" id="commentForm">
                  {% csrf_token %}
                  <div class="control">
                    {{ comment_form|crispy }}
                  </div>
                  <div class="compose-controls">
                    {% if user.is_authenticated %}
                    <button class="button is-solid accent-button raised"> Post Comment</button>
                    {% else %}
                    <h6> Please login to post your comment: </h6>
                    <a class="btn btn-dark btn-xl js-scroll-trigger text-dark"
                      href="{% url 'account_login' %}">{% trans 'Login' %}</a>
                  </div>
                </form>
                {% endif %}
              </div>
            </div>
            {% endif %}

          </div>

          <div class="comments-wrap">
            <div class="comments-count">
              {% with comments.count as total_comments %}
              <h3>
                Comment {{ total_comments|pluralize }} ({{ total_comments }})

              </h3>
              {% endwith %}
            </div>
            {% for comment in comments %}
            <!-- Comment -->
            <div class="media is-comment">
              <figure class="media-left">
                <div class="avatar-wrap is-smaller">
                  {% if comment.user.thumbnail %}
                  <img src="{{oss}}/{{comment.user.thumbnail}}"
                    style="border-radius: 50%;" alt="">
                  {% else %}
                  <img src="{% static 'img/user.png' %}" style="border-radius: 50%;" alt="">
                  {% endif %}

                </div>
              </figure>
              <div class="media-content">
                <div class="comment-meta">
                  <h4><a>{{ comment.user.get_profile_name|title }}</a> <small> · {{ comment.created }}</small></h4>
                  <p>{{ comment.body|linebreaks }}</p>
                </div>
              </div>
            </div>

            {% empty %}
            <p>There are no comments yet.</p>
            {% endfor %}

          </div>
        </div>
      </div>


    </div>
  </div>
</div>
<!-- /.container -->
{% endblock content %}

{% block extra_js %}
<script type="text/javascript">
  var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
  var url = "{% url 'posts:post' post.slug %}"
  var editUrl = "{% url 'posts:edit_post' post.pk %}"
</script>

<link rel="stylesheet" href="{% static 'css/share.css' %}">
<link rel="stylesheet" href="{% static 'css/wnoty.css' %}">
<script src="{% static 'js/share.js' %}" type="text/javascript"></script>
<script src="{% static 'js/details.js' %}" type="text/javascript"></script>
<script src="{% static 'frontend/assets/js/app.js' %}"></script>
<script src="{% static 'js/wnoty.js' %}" type="text/javascript"></script>

<!-- Need to fix issues parsing markdown to plain text to use here for articlebody and others -->
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{ post.title|title }}",
    "image": "https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{post.image}}",
    "url": "{% url 'posts:post' post.slug %}",
    "datePublished": "{{ post.timestamp }}",
    "dateCreated": "{{ post.timestamp }}",
    "dateModified": "{{ post.timestamp }}",
    "description": "{{ post.title|title }}",
    "author": {
      "@type": "Person",
      "name": "{{ post.user.get_profile_name|title }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Obrisk",
      "logo": {
        "@type": "ImageObject",
        "url": "https://obrisk.com/static/img/favicon.png"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{% url 'posts:post' post.slug %}"
    }
  }
</script>


{% endblock extra_js %}
