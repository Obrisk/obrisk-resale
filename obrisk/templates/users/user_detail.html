{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ object.username }}{% endblock %}

{% block head %}
<link href="{% static 'css/user_profile.css' %}" rel="stylesheet">

{% endblock head %}

{% block content %}

<div>
  <div class="media profile profile-header m-2">
    {% if object.picture %}
        <img src="https://obrisk.oss-cn-hangzhou.aliyuncs.com/{{object.picture}}" alt="Picture Profile"
          class="mb-3 profile-header-avatar img-fluid profile-pic" id="pic">
    {% else %}
        <img class="pull-right" src="{% static 'img/user.png' %}" height="250px" alt="No Profile Picture" />
        <small class="lazy-img"> {{ object.username }} is too lazy to upload the profile pic.</small>
    {% endif %}

    <h1 class="media-body mt-0">{{ object.username|title }}</h1>

    <div class="profile-points">
      <div class="point-label"> <i class="fa fa-gift"> </i> {% trans 'Points' %}</div>
      <div class="points"> {{ object.points }} </div>
    </div>

      {% if request.user.username == object.username %}
          <div class="is-flex mb-2">
            <a class="button accent-button m-2" href="{% url 'users:update' %}">{% trans 'Update Profile' %}</a>
          </div>

      {% else %}
          <div class="is-flex mb-2">
            {% if object in friends %}
                <a class="button accent-button m-2 go-to-chat"
                  data-url="{% url 'messager:conversation_detail' object.username  %}">{% trans '💬Chat' %}</a>
            {% elif object in pending %}
                <a class="button accent-button m-2" href="#">{% trans 'Pending' %}</a>
            {% elif object in pended%}
                {{object.username|title }} Wants to connect with you 🔌
                <a class="button accent-button m-2" 
                    href="{% url 'connections:friendship_request_list' %}">view all requests</a>
            {% else %}
                <a class="connect-btn button accent-button m-2" href="#">{% trans '➕Connect' %}</a>
            {% endif %}
          </div>
      {% endif %}
  </div>

  <div class="container profile-wrapper">

    <div id="contact-info" class="vcard">
      <p>
        {% if object.instagram_account %}
        <a href="https://www.instagram.com/{{ object.instagram_account }}" style="font-size: 2em"
          title="{% trans 'Instagram Profile' %}"><i class="fa fa-instagram"></i> </a>
        {% endif %}

        {% if object.linkedin_account %}
        <a href="https://www.linkedin.com/in/{{ object.linkedin_account }}" style="font-size: 2em"
          title="{% trans 'LinkedIn Profile' %}"><i class="fa fa-linkedin"></i> </a>
        {% endif %}

        {% if object.snapchat_account %}
        <a href="https://www.snapchat.com/add/{{ object.snapchat_account }}" style="font-size: 2em"
          title="{% trans 'Snapchat Profile' %}"><i class="fa fa-snapchat"></i> </a>
        {% endif %}

        {% if object.facebook_account %}
        <a href="https://www.facebook.com/{{ object.facebook_account }}" style="font-size: 2em"
          title="{% trans 'Facebook Profile' %}"><i class="fa fa-facebook"></i> </a>
        {% endif %}

        <br />
        {% if object.name %}
        👤{{ object.name|title  }}
        {% endif %}

        <br />
        {% if object.city %}
        <span class="fa"> 📍{{ object.city }} </span> <br />
        {% endif %}
        <br />
        {% if object.job_title %}
        💼{{ object.job_title }} <br />
        {% else %}
        <p>🛌 {{ object.username }} is too lazy to add a job title.</p>
        {% endif %}
      </p>

      {% if object.bio %}
      <div class="panel-body" id="objective">
        <p>📇{{ object.bio }}</p>
      </div>
      {% else %}
      <p> 🛌{{ object.username}} is too lazy to write a short bio.</p>
      {% endif %}
      <div class="clear"></div>
    </div>

  </div>
  {% csrf_token %}
</div>

{% endblock content %}

{% block extra_js %}

<link href="{% static 'css/wnoty.css' %}" rel="stylesheet"/>

<script src="{% static 'js/vendor/jquery.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/wnoty.js' %}" type="text/javascript"></script>
<script>
  const csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
  const username = "{{ object.username }}";

  $(".connect-btn").click(function (e) {

    $.ajax({
      type: "POST",
      url: "/connections/friend/add/" + username + "/",
      data: {
        to_username: username
      },
      dataType: "json",
      success: function (response) {
        if (response) {
          $.wnoty({
            type: "success",
            message: response.message,
          });
        } else {
          $.wnoty({
            type: "error",
            autohide: false,
            message: "Sorry something went wrong , Please try again later.",
          });
        }
      }
    });
  });


  $(".follow-btn").click(function (e) {

    $.ajax({
      type: "POST",
      url: "/connections/follower/add/" + username + "/",
      data: {
        followee_username: username
      },
      dataType: "json",
      success: function (response) {
        if (response) {
          $.wnoty({
            type: "success",
            message: "You're now following" + username + "🔌",
          });
        } else {
          $.wnoty({
            type: "error",
            autohide: false,
            message: "Sorry something went wrong , Please try again later.",
          });
        }
      }
    });
  });

  //setcookies to open chat window
  var setCookie = function (name, value, days) {
    if (!name && !value) {
      return false;
    } else if (days) {
      var date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      var expires = "; expires=" + date.toGMTString();
    }
    else var expires = "";
    document.cookie = name + "=" + value + expires + "; path=/";
    return true;
  }
  $(".go-to-chat").click(function (e) {
    e.preventDefault();
    setCookie("active-chat", $(this).data("url"), 1);
    location.href = "/ws/messages/";

  });
</script>

{% endblock extra_js %}
