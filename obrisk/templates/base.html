{% load static i18n humanize %}
{% load pwa_webpush %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <!--Please ensure sipts are loaded from my site only!-->
  <!-- <meta http-equiv="x-ua-compatible" content="ie=edge"> -->
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="google-site-verification" content="NVNmEgtDfFzJD89nlq7dQDSCMAGj-q_d3JI0buqyxJ4" />
  <meta name="description"
      content="secondhand website app for foreigners in China to buy and sell used stuff, find apartments for rent and local services">
  <meta name="keywords"
    content="secondhand Hangzhou, secondhand China, China Classifieds, secondhand, classifieds, China expats, foreigners in China">
  <meta name="author" content="Obrisk team">
  <meta name="apple-mobile-web-app-title" content="Obrisk">
  <meta name="locale" content="en">
  <meta name="theme-color" content="#3EC4E2">
  <meta name="vapid-key" content="{{ vapid_key }}">

  <!-- Icon can be replace to show icon on share -->
  {% block icon %}
  <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
  <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/apple-touch-icon.png' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/favicon-32x32.png' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon-16x16.png' %}">
  {% endblock icon%}

  {% if request.user.is_authenticated %}
      {% webpush_header %}
      <meta name="user_id" content="{{ request.user.id }}">
  {% endif %}

  <!-- PWA settings -->
  {% progressive_web_app_meta %}
  <meta name="apple-mobile-web-app-capable" content="yes">

  {% block cdn %}
      <link rel="stylesheet" href="{% static 'css/bulma.css' %}">
      <link rel="stylesheet" type="text/css" href="{% static 'css/nav.css' %}">
  {% endblock cdn %}

  {% block head %}
  {% endblock head %}
</head>

<body class="has-slimscroll">
  <!-- Pageloader -->
  {% block body %}

    <nav id="navbarTop" class="navbar is-fixed-top">
      <div class="nav-inner isible is-toggle is-fullwidth">
        <ul class="tp-nav-ul">
          <li >
            {% if request.META.HTTP_REFERER %}
                <a  href="javascript:history.back()">
                    <svg  class="feather feather-arrow-left-circle nav-back-btn" xmlns="http://www.w3.org/2000/svg"
                         width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 8 8 12 12 16"></polyline>
                        <line x1="16" y1="12" x2="8" y2="12"></line>
                    </svg>
                </a>
            {% else  %}

            <a class="nav-logo" href="{% url 'classifieds:list' %}">
              <svg width="64" height="48" viewBox="0 0 64 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#filter0_i)">
                  <path d="M23.4699 10.0511C23.1315 9.98326 22.8706 9.90461 22.7042 9.81386L23.4699 10.0511Z"
                    fill="url(#paint0_linear)" />
                  <path
                    d="M14.0874 16.5869C19.4435 21.3157 27.2428 27.6592 32.564 31.2283L35.5688 18.659L38.5202 16.5869C34.6513 15.6786 35.5853 15.8594 30.0091 13.677C26.4935 12.301 7.02249 2.924 7.02249 2.924C10.3003 6.22432 23.2722 15.2348 28.8079 17.6348C22.0029 16.3408 15.2866 12.0666 10.3798 8.94405L10.2721 8.87547C4.00446 4.88709 0.880462 3.05549 0 2.10975C1.78415 6.11332 8.73125 11.8582 14.0874 16.5869Z"
                    fill="url(#paint1_linear)" />
                  <path
                    d="M16.0371 23.2212C19.7932 29.0869 24.8639 32.8112 29.2773 37.6527L28.6308 36.7285L28.119 35.8043L27.2904 33.9558L26.6934 32.1074L26.3052 30.259L30.3991 32.0303C27.3054 31.2284 19.1046 26.2317 16.0371 23.2212Z"
                    fill="#00BAF6" />
                  <path
                    d="M22.7981 9.62769L33.0334 13.0726L34.1603 12.2347L35.4749 11.3887L36.9208 10.6519L38.4798 10.0249C36.8834 10.956 30.4042 10.2794 29.0895 10.2794C28.0378 10.2794 24.457 9.8139 22.7981 9.62769Z"
                    fill="#00BAF6" />
                  <path
                    d="M63.27 27.411C63.27 17.2296 54.9458 8.97595 44.6773 8.97595C40.2126 8.97595 36.2386 10.4719 33.0334 13.0726C33.0029 13.0623 33.075 13.0502 33.0334 13.0726L37.2951 14.5424C39.426 13.3687 41.879 12.7002 44.4895 12.7002C52.6835 12.7002 59.3261 19.2865 59.3261 27.411C59.3261 35.5356 52.6835 42.1218 44.4895 42.1218C37.9229 42.1218 32.3527 37.8919 30.3991 32.0303L28.9956 31.535L27.7749 30.982L26.3052 30.259C27.6861 39.0881 35.3857 45.8461 44.6773 45.8461C54.9458 45.8461 63.27 37.5924 63.27 27.411Z"
                    fill="#00BAF6" />
                  <path
                    d="M26.0982 26.7007C26.1107 26.374 26.1317 26.0495 26.1611 25.7274C26.134 26.0455 26.1129 26.37 26.0982 26.7007Z"
                    fill="#00BAF6" />
                  <g filter="url(#filter1_d)">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                      d="M44.4897 14.9348C51.439 14.9348 57.0726 20.5206 57.0726 27.411C57.0726 34.3014 51.439 39.8873 44.4897 39.8873C37.5403 39.8873 31.9067 34.3014 31.9067 27.411C31.9067 20.5206 37.5403 14.9348 44.4897 14.9348Z"
                      fill="url(#paint2_radial)" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                      d="M44.4897 14.9348C51.439 14.9348 57.0726 20.5206 57.0726 27.411C57.0726 34.3014 51.439 39.8873 44.4897 39.8873C37.5403 39.8873 31.9067 34.3014 31.9067 27.411C31.9067 20.5206 37.5403 14.9348 44.4897 14.9348Z"
                      fill="url(#paint3_linear)" />
                  </g>
                  <g opacity="0.6" filter="url(#filter2_d)">
                    <path
                      d="M57.1561 27.3172C57.1561 20.4268 51.5225 14.8409 44.5732 14.8409C37.6238 14.8409 31.9902 20.4268 31.9902 27.3172C31.9902 34.2076 37.6238 39.7934 44.5732 39.7934C51.5225 39.7934 57.1561 34.2076 57.1561 27.3172Z"
                      fill="#00BAF6" />
                  </g>
                </g>
                <defs>
                  <filter id="filter0_i" x="0" y="-2.89025" width="63.27" height="48.7363" filterUnits="userSpaceOnUse"
                    color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix" />
                    <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                      result="hardAlpha" />
                    <feOffset dy="-5" />
                    <feGaussianBlur stdDeviation="30" />
                    <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                    <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.6 0" />
                    <feBlend mode="overlay" in2="shape" result="effect1_innerShadow" />
                  </filter>
                  <filter id="filter1_d" x="27.9067" y="14.9348" width="33.1659" height="32.9525"
                    filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix" />
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                    <feOffset dy="4" />
                    <feGaussianBlur stdDeviation="2" />
                    <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
                    <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                    <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape" />
                  </filter>
                  <filter id="filter2_d" x="27.9902" y="14.8409" width="33.1659" height="32.9525"
                    filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix" />
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                    <feOffset dy="4" />
                    <feGaussianBlur stdDeviation="2" />
                    <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
                    <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                    <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape" />
                  </filter>
                  <linearGradient id="paint0_linear" x1="55.2858" y1="38.3233" x2="13.1949" y2="-9.44434"
                    gradientUnits="userSpaceOnUse">
                    <stop offset="0.270833" stop-color="#EB5757" />
                    <stop offset="0.557292" stop-color="#56CCF2" />
                  </linearGradient>
                  <linearGradient id="paint1_linear" x1="55.2858" y1="38.3233" x2="13.1949" y2="-9.44434"
                    gradientUnits="userSpaceOnUse">
                    <stop offset="0.270833" stop-color="#EB5757" />
                    <stop offset="0.557292" stop-color="#56CCF2" />
                  </linearGradient>
                  <radialGradient id="paint2_radial" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse"
                    gradientTransform="translate(49.9663 30.4821) rotate(-128.694) scale(17.7726 13.2688)">
                    <stop offset="0.015625" stop-color="#EB5757" />
                    <stop offset="1" stop-color="#56CCF2" />
                  </radialGradient>
                  <linearGradient id="paint3_linear" x1="44.4897" y1="39.8873" x2="44.4897" y2="14.9348"
                    gradientUnits="userSpaceOnUse">
                    <stop stop-color="white" />
                    <stop offset="1" stop-color="white" stop-opacity="0" />
                  </linearGradient>
                </defs>
              </svg>
            </a>

            {% endif %}
          </li>

        {% if request.user.is_authenticated %}
          <li class="top-nav-user-li">
            <a href="#du" class="user-image navbar-item is-account drop-trigger">
                  {% if request.user.thumbnail %}
                    <img   src="{{ oss }}/{{request.user.thumbnail}}" alt="Picture Profile"
                      style="width:30px;height:30px;border-radius: 50%;"
                      class="img-drop-trigger rounded-circle  mb-3 mb-md-0 mr-0 md-3 img-fluid" id="thumb-pic" />
                  {% else %}
                    <img src="{% static 'img/user.png' %}" height="30px" width="30px" alt="No Profile Picture" />
                  {% endif %}
            </a>

            <div id="du" class="has-caret">
                  <div class="nav-drop is-account-dropdown">
                    <div class="inner">
                      <div class="nav-drop-header is-auth-user">
                        <span class="username">{{ request.user.username|truncatechars:12}}</span>
                        <a href="#" id="close">❌ 
                            {% trans 'CLOSE' %}
                        </a>
                      </div>

                      <div class="nav-drop-body account-items">
                        <a class="account-item" href="{% url 'users:detail' request.user.username  %}">
                          <div class="media">
                            <div class="icon-wrap">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                class="feather feather-user">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" /></svg>
                            </div>
                            <div>
                                <h3>
                                    {% trans 'My Profile' %}
                                </h3>
                                <small>
                                    {% trans 'Access profile & settings' %}
                                </small>
                            </div>
                          </div>
                        </a>

                        <a class="account-item" href="{% url 'account_logout' %}">
                          <div class="media">
                            <div class="icon-wrap">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                class="feather feather-power">
                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                                <line x1="12" y1="2" x2="12" y2="12"></line>
                              </svg>
                            </div>
                            <div>
                                <h3>
                                    {% trans 'Log out' %}
                                </h3>
                                <small>
                                    {% trans 'Log out from your account.' %}
                                </small>
                            </div>
                          </div>
                        </a>
                      <!-- close nav-drop-body -->
                      </div>

                   <!-- close inner div-->
                   </div>

                <div class="nav-drop acc-nav-toggle" id=""> 
                </div>

               <!-- close inner, nav-drop, ac-dropdown -->
              </div>
            </div>
          </li>

        {% else %}
            <li class="top-nav-user-li">
            <a href="#d" class="user-image navbar-item is-account drop-trigger">
                      <img class="user-image" src="{% static 'img/user.png' %}"
                        height="30px" width="30px" alt="No Profile Picture" />
            </a>

            <div id="d" class="has-caret">
                  <div class="nav-drop is-navbarTop is-account-dropdown">
                    <div class="inner">
                          <div class="nav-drop-header guest-user">
                            <a href="#" id="close">❌ CLOSE</a>
                          </div>

                          <div class="nav-drop-body account-items">
                                <a class="account-item" href="{% url 'account_login' %}">
                                  <div class="media">
                                    <div class="icon-wrap">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-user">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                        <circle cx="12" cy="7" r="4" /></svg>
                                    </div>
                                    <div>
                                      <h3>Login</h3>
                                    </div>
                                  </div>
                                </a>

                                <a class="account-item" href="{% url 'account_signup' %}">
                                  <div class="media">
                                    <div class="icon-wrap">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-user-plus">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                        <circle cx="8.5" cy="7" r="4" />
                                        <line x1="20" y1="8" x2="20" y2="14" />
                                        <line x1="23" y1="11" x2="17" y2="11" /></svg>
                                    </div>
                                    <div>
                                      <h3>Sign up</h3>
                                    </div>
                                  </div>
                                </a>
                            </div>
                     <!-- close inner, nav-drop, ac-dropdown -->
                    </div>
                  </div>
                </div>
          </li>
       {% endif %}

        </ul>
      </div>
    </nav>


    <nav id="navbarBottom" class="navbar fixed-bottom is-hidden-tablet">
        <ul class="bt-nav-ul is-toggle is-fullwidth">

         <li class="bt-nav-item {% if base_active == 'classifieds' %} is-active {% endif %}">
            <a class="bt-nav-link" href="{% url 'classifieds:list' %}">
                <span class="nav-icons">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="feather feather-shopping-bag">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
              </span>
              <span class="nav-label">
                  {% trans 'Items' %}
              </span>
            </a>
          </li>

          <li class="bt-nav-item">
            <a class="bt-nav-link" href="{% url 'classifieds:write_new' %}"
            id="addNewItem">
                <span class="nav-icons">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-square">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
              </span>
              <span class="nav-label">
                  {% trans 'Add' %}
              </span>
            </a>
          </li>

          <li class="bt-nav-item {% if base_active == 'chat' %} is-active {% endif %}">
            <a class="bt-nav-link" href="{% url 'messager:contacts_list' %}">
              <span class="nav-icons">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="feather feather-message-square">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
              </span>
              <span class="nav-label">
                {% trans 'Chat' %}
              </span>
              {% if request.user.is_authenticated %}
                  <span } class="msg-notification ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                        viewBox="0 0 24 24" fill="#EB5757" stroke="#EB5757"
                        stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-circle"><circle cx="12" cy="12" r="10"></circle>
                    </svg>
                  </span>
              {% endif %}
            </a>
          </li>

        </ul>
    </nav>

    <div class="container is-hidden-mobile"> 
        <div class='my-5'>
            <p>This platform works best on Wechat</p>
            <p>Please use Wechat to scan the QR-code below </p>
            <img src="{% static 'img/qrcode.jpg' %}" alt="Obrisk QRcode"/>
        </div>
    </div>

    <div class='container is-hidden-tablet'>
        <!-- These messages are not from chat, they are the notifications msgs
        upon successful POST request on the chat the message context is message_list -->
        {% if messages %}
            {% for message in messages %}
              <div class="notification 
                 {% if message.tags == 'error' %}is-danger{% else %}is-primary{% endif %}">
                <button type="button" class="delete close-dj-messages"></button>
                {{ message}}
              </div>
            {% endfor %}

           <script type="text/javascript">
                document.querySelectorAll('.close-dj-messages').forEach(item => {
                  item.addEventListener('click', e => {
                    e.currentTarget.parentElement.remove();
                    e.stopPropagation();
                  });
                });
          </script>

        {% endif %}

        {% block content %}

        {% endblock content %}
    </div>


  {% block javascript %}
  <script type="text/javascript">
    var currentUser;
    var new_messages;

    function registerServiceWorker() {
      // register sw script in supporting browsers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js', { scope: '/' }).then(() => {
          console.log('Service Worker registered successfully.');
        }).catch(error => {
          console.log('Service Worker registration failed:', error);
        });
      }
    }

    //fix navbar bottom on iphone X families
    let iPhone = /iPhone/.test(navigator.userAgent) && !window.MSStream;
    let aspect = window.screen.width / window.screen.height;
    if (
      iPhone && (aspect.toFixed(3) === "0.462" ||
        aspect.toFixed(3) === "0.576" ||
        aspect.toFixed(3) === "0.591")
    ) {
      document.getElementById("navbarBottom").classList.add("iphone-nav-bt");
    }

    var setCookie = function (name, value, seconds) {
        if (!name && !value) {
          return false;
        } else if (seconds) {
          var date = new Date();
          date.setTime(date.getTime() + (seconds * 1000));
          var expires = "; expires=" + date.toGMTString();
        }
        else var expires = "";
        document.cookie = name + "=" + value + expires + "; path=/";
        return true;
    }

    var getCookie = function(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) === " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    var deleteCookie = function(name) {
        if (name) {
          setCookie(name, "", -1);
          return true;
        }
    }
  </script>

  {% if request.user.is_authenticated %}

      <script type="text/javascript">
        currentUser = "{{ request.user.username}}";
        new_messages = "{{ new_msgs }}";
      </script>
      <script src="{% static 'js/obrisk.js' %}" type="text/javascript"></script>

  {% endif %}

  {% endblock javascript %}

  {% block extra_js %}{% endblock extra_js %}

</body>
{% endblock body %}

</html>
